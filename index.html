<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staking Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Three.js CDN for 3D background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');


        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrollbar from background animation */
        }

        /* CSS Variables for Theming */
        :root {
            --animated-bg-gradient: radial-gradient(circle at center, #1a202c, #0f172a);
            --card-gradient-blue-purple: linear-gradient(135deg, rgba(0, 0, 30, 0.7), rgba(20, 0, 50, 0.7));
            --card-gradient-green-cyan: linear-gradient(135deg, rgba(0, 30, 0, 0.7), rgba(0, 30, 30, 0.7));
            --card-gradient-orange-red: linear-gradient(135deg, rgba(30, 10, 0, 0.7), rgba(30, 0, 0, 0.7));
            --card-gradient-yellow-pink: linear-gradient(135deg, rgba(30, 20, 0, 0.7), rgba(30, 0, 15, 0.7));
            --card-gradient-indigo-fuchsia: linear-gradient(135deg, rgba(10, 15, 30, 0.7), rgba(20, 0, 20, 0.7));
            --text-color-primary: #FFFFFF; /* Pure white */
            --text-color-secondary: #e2e8f0; /* Light gray */
            --text-color-accent-blue: #93c5fd;
            --text-color-accent-green: #4ade80;
            --text-color-accent-yellow: #facc15;
            --text-color-accent-purple: #c084fc;
            --text-color-accent-red: #fca5a5;
            --header-text-color: #63b3ed; /* blue-400 */
            --header-bg-color: rgba(255, 255, 255, 0.15);
            --header-border-color: rgba(255, 255, 255, 0.2);
            --button-primary-gradient-start: #63b3ed;
            --button-primary-gradient-end: #4299e1;
            --button-primary-hover-gradient-start: #4299e1;
            --button-primary-hover-gradient-end: #63b3ed;

            /* New UI Variables */
            --font-family-primary: 'Inter', sans-serif;
            --font-size-base: 16px; /* Default base font size */
            --panel-bg-opacity: 0.08; /* Default card background opacity */
            --panel-border-radius: 12px; /* Default panel border radius */
            --text-color-heading: #63b3ed; /* Default heading color */
            --icon-size: 1em; /* Default icon size */
            --panel-base-background-color-rgb: 255, 255, 255; /* Default white for rgba blend */

            /* Start Screen Specific Variables */
            --start-screen-title-font-size: 3rem; /* Default 3xl */
            --start-screen-subtitle-font-size: 1.25rem; /* Default xl */
            --start-screen-panel-padding: 1rem; /* Default p-4 */
        }

        /* Apply CSS Variables */
        body {
            font-family: var(--font-family-primary);
            font-size: var(--font-size-base);
        }
        .animated-background {
            background: var(--animated-bg-gradient);
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .glass-panel {
            background-color: var(--header-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--header-border-color);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--panel-border-radius); /* Use variable */
        }

        .card {
            /* Use rgba with base color and opacity for flexible background */
            background-color: rgba(var(--panel-base-background-color-rgb), var(--panel-bg-opacity));
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            border-radius: var(--panel-border-radius); /* Use variable */
            color: var(--text-color-primary); /* Use primary text color */
        }
        /* Gradient classes for cards, these will override the base background-color */
        .card.gradient-blue-purple { background: var(--card-gradient-blue-purple); }
        .card.gradient-green-cyan { background: var(--card-gradient-green-cyan); }
        .card.gradient-orange-red { background: var(--card-gradient-orange-red); }
        .card.gradient-yellow-pink { background: var(--card-gradient-yellow-pink); }
        .card.gradient-indigo-fuchsia { background: var(--card-gradient-indigo-fuchsia); }

        .card p, .card ul li { color: var(--text-color-primary); }
        .card h3, .card h4 { color: var(--text-color-heading); } /* Apply heading color */
        .card .text-blue-300 { color: var(--text-color-accent-blue); }
        .card .text-blue-200 { color: var(--text-color-accent-blue); } /* Use same for 200/300 for simplicity */
        .card .text-green-400 { color: var(--text-color-accent-green); }
        .card .text-yellow-400 { color: var(--text-color-accent-yellow); }
        .card .text-purple-400 { color: var(--text-color-accent-purple); }
        .card .text-green-300 { color: var(--text-color-accent-green); }
        .card .text-red-300 { color: var(--text-color-accent-red); }
        .card .text-yellow-300 { color: var(--text-color-accent-yellow); }
        .card .text-indigo-300 { color: var(--text-color-accent-blue); } /* Use accent blue for indigo */
        .card .text-gray-500 { color: var(--text-color-secondary); }
        .card .font-mono { color: var(--text-color-secondary); }

        .btn-primary {
            background-image: linear-gradient(to right, var(--button-primary-gradient-start), var(--button-primary-gradient-end));
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, var(--button-primary-hover-gradient-start), var(--button-primary-hover-gradient-end));
        }

        /* Original styles (not using variables for now, but can be updated) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #63b3ed;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4299e1;
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            /* Now uses glass-panel */
            margin: auto;
            padding: 20px;
            border-radius: var(--panel-border-radius); /* Use variable */
            width: 80%; /* Could be more responsive */
            max-width: 500px;
            text-align: center;
            color: var(--text-color-secondary);
        }

        .modal-close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .modal-close-button:hover,
        .modal-close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        /* Animation for form elements */
        .input-field, .btn {
            transition: all 0.3s ease-in-out;
        }

        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5); /* Tailwind blue-300 with transparency */
            border-color: #63b3ed; /* Tailwind blue-400 */
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background-image: linear-gradient(to right, #a0aec0, #718096);
        }
        .btn-secondary:hover {
            background-image: linear-gradient(to right, #718096, #a0aec0);
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px; /* full rounded */
            font-weight: bold;
            color: white;
            background-color: #4299e1; /* Default blue - remains solid for emphasis */
        }

        .level-0 { background-color: #a0aec0; } /* Gray */
        .level-1 { background-color: #4299e1; } /* Blue */
        .level-2 { background-color: #38a169; } /* Green */
        .level-3 { background-color: #d69e2e; } /* Yellow-orange */
        .level-4 { background-color: #ed8936; } /* Orange */
        .level-5 { background-color: #e53e3e; } /* Red */

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #63b3ed;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #threeJsCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* Input field adjustments for glass theme */
        .input-field {
            background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent */
            border-color: rgba(255, 255, 255, 0.3); /* Lighter border */
            color: var(--text-color-primary); /* Ensure text is readable */
        }
        .input-field::placeholder {
            color: rgba(226, 232, 240, 0.7); /* Lighter placeholder text */
        }

        /* Ensure start screen text is on top of canvas */
        #startScreen > h2, #startScreen > p, #startScreen > div, #startScreenCustomContent {
            position: relative;
            z-index: 1;
        }

        /* Apply dynamic font sizes for start screen */
        #startScreenTitle {
            font-size: var(--start-screen-title-font-size);
        }
        #startScreenSubtitle {
            font-size: var(--start-screen-subtitle-font-size);
        }
        #startScreenPanel {
            padding: var(--start-screen-panel-padding);
        }


        /* Ensure proper text alignment within cards */
        .card div, .card p, .card h3, .card h4, .card ul {
            text-align: left; /* Default to left alignment for content */
            width: 100%; /* Ensure elements take full width for alignment */
        }
        .card .text-center {
            text-align: center; /* Override for specific centered elements */
        }
        .card .flex {
            justify-content: space-between; /* Maintain existing flex behaviors */
            align-items: center;
        }

        /* Icon size adjustment */
        .fa-solid, .fa-regular, .fa-brands {
            font-size: var(--icon-size);
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <div class="animated-background"></div>

    <!-- Modal for messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content glass-panel">
            <span class="modal-close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold"></p>
            <div id="modalButtons" class="mt-4 flex justify-center space-x-4">
                <button id="modalOkButton" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">OK</button>
                <button id="modalCancelButton" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors hidden">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-panel p-4 shadow-lg flex justify-between items-center z-10">
        <h1 id="websiteTitle" class="text-3xl font-bold text-blue-400">Staking Hub</h1>
        <nav id="mainNav" class="space-x-4">
            <button id="showSignInBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Sign In</button>
            <button id="showSignUpBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Sign Up</button>
            <button id="signOutBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden">Sign Out</button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow flex items-center justify-center p-4">

        <!-- Start Screen -->
        <section id="startScreen" class="relative text-center transition-opacity duration-500 ease-in-out flex flex-col items-center justify-center overflow-hidden w-full h-full">
            <canvas id="threeJsCanvas" class="absolute inset-0 w-full h-full z-0"></canvas>
            <div id="startScreenPanel" class="relative z-10 p-4 glass-panel rounded-lg shadow-xl">
                <h2 class="text-5xl font-extrabold text-white mb-6 animate-pulse" id="startScreenTitle">Staking Hub</h2>
                <p class="text-xl text-gray-300 mb-8" id="startScreenSubtitle">Unlock Your Financial Potential. Securely stake USDT and earn daily rewards.</p>
                <!-- Custom Start Screen Content will be injected here -->
                <div id="startScreenCustomContent" class="mb-8 space-y-4"></div>

                <button id="getStartedBtn" class="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xl font-bold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">Get Started</button>
            </div>
        </section>

        <!-- Sign Up Form -->
        <section id="signUpForm" class="hidden w-full max-w-md glass-panel p-8 rounded-xl shadow-2xl transition-opacity duration-500 ease-in-out">
            <h2 class="text-3xl font-bold text-center text-blue-400 mb-6">Create Your Account</h2>
            <form id="signUp" class="space-y-4">
                <div>
                    <label for="signUpEmail" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="signUpEmail" class="input-field shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="signUpPassword" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="signUpPassword" class="input-field shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Minimum 6 characters" required minlength="6">
                </div>
                <div>
                    <label for="referralCode" class="block text-gray-300 text-sm font-bold mb-2">Referral Code (Mandatory):</label>
                    <input type="text" id="referralCode" class="input-field shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter referral code" required>
                </div>
                <button type="submit" class="btn btn-primary w-full py-3 rounded-lg font-bold text-lg">Sign Up</button>
            </form>
            <p class="text-center text-gray-400 text-sm mt-4">Already have an account? <a href="#" id="linkToSignIn" class="text-blue-400 hover:underline">Sign In</a></p>
        </section>

        <!-- Sign In Form -->
        <section id="signInForm" class="hidden w-full max-w-md glass-panel p-8 rounded-xl shadow-2xl transition-opacity duration-500 ease-in-out">
            <h2 class="text-3xl font-bold text-center text-blue-400 mb-6">Welcome Back!</h2>
            <form id="signIn" class="space-y-4">
                <div>
                    <label for="signInEmail" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="signInEmail" class="input-field shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="signInPassword" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="signInPassword" class="input-field shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Your password" required>
                </div>
                <button type="submit" class="btn btn-primary w-full py-3 rounded-lg font-bold text-lg">Sign In</button>
            </form>
            <p class="text-center text-gray-400 text-sm mt-4">Don't have an account? <a href="#" id="linkToSignUp" class="text-blue-400 hover:underline">Sign Up</a></p>
        </section>

        <!-- User Dashboard -->
        <section id="userDashboard" class="hidden w-full max-w-6xl glass-panel p-8 rounded-xl shadow-2xl grid grid-cols-1 md:grid-cols-3 gap-8 transition-opacity duration-500 ease-in-out custom-scrollbar overflow-y-auto max-h-[calc(100vh-160px)]">
            <!-- Left Column: Balances & Level -->
            <div class="md:col-span-1 space-y-8">
                <div id="userOverviewPanel" class="card gradient-blue-purple">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Your Staking Overview</h3>
                    <p class="text-gray-100 text-base mb-2">User ID: <span id="dashboardUserId" class="font-mono text-sm break-all text-blue-200"></span></p>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xl text-gray-100">Total USDT Balance:</p>
                        <p class="text-4xl font-bold text-green-400" id="totalUsdtBalance">0.00 USDT</p>
                    </div>
                </div>

                <div id="userLevelPanel" class="card gradient-green-cyan">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Your Staking Level</h3>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xl text-gray-100">Current Level:</p>
                        <div id="currentLevelBadge" class="level-badge level-0">0</div>
                    </div>
                    <p class="text-xl text-gray-100 mb-2">Interest Rate: <span id="interestRate">0%</span></p>
                    <p class="text-xl text-gray-100 mb-2">Minimum Balance: <span id="minBalance">0 USDT</span></p>
                    <p class="text-xl text-gray-100">Monthly Withdrawal Limit: <span id="monthlyWithdrawalLimit">0 USDT</span></p>
                </div>

                <!-- Daily Interest Credit Panel -->
                <div id="dailyInterestPanel" class="card gradient-orange-red">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Daily Interest Credit</h3>
                    <p class="text-xl text-gray-100 mb-3" id="dailyInterestMessage">Next credit in:</p>
                    <p class="text-5xl font-bold text-purple-400 text-center" id="dailyInterestTimer">00h 00m 00s</p>
                </div>
            </div>

            <!-- Middle Column: Actions (Recharge, Withdraw) -->
            <div class="md:col-span-1 space-y-8">
                <div id="rechargePanel" class="card gradient-yellow-pink">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Recharge USDT (BEP-20)</h3>
                    <!-- Deposit Restriction Messages will appear here -->
                    <div id="depositRestrictionMessages" class="mb-3 space-y-2"></div>

                    <p class="text-xl text-gray-100 mb-3">Copy this address to deposit USDT (BEP-20):</p>
                    <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between mb-4">
                        <span class="font-mono text-base break-all text-green-300" id="rechargeAddress"></span>
                        <button onclick="copyToClipboard(document.getElementById('rechargeAddress').textContent)" class="ml-2 p-2 bg-blue-500 rounded-md text-white hover:bg-blue-600 transition-colors">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p class="text-xl text-gray-100 mb-3">Enter amount and confirm you've sent the funds:</p>
                    <input type="number" id="rechargeAmount" class="input-field w-full py-3 px-4 mb-4 text-xl" placeholder="Amount in USDT (e.g., 100)" min="1" step="0.01">
                    <button id="submitRechargeBtn" class="btn btn-primary w-full py-3 rounded-lg font-bold text-lg">Submit Recharge Request</button>
                    <p class="text-base text-gray-500 mt-2">Recharges require admin approval to reflect in your balance.</p>
                </div>

                <div id="withdrawPanel" class="card gradient-indigo-fuchsia">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Withdraw USDT</h3>
                    <!-- Withdrawal Restriction Messages will appear here -->
                    <div id="withdrawalRestrictionMessages" class="mb-3 space-y-2"></div>

                    <p class="text-xl text-gray-100 mb-3">Minimum withdrawal: 100 USDT</p>
                    <input type="number" id="withdrawAmount" class="input-field w-full py-3 px-4 mb-4 text-xl" placeholder="Amount in USDT (e.g., 100)" min="100" step="0.01">
                    <input type="text" id="withdrawAddress" class="input-field w-full py-3 px-4 mb-4 text-xl" placeholder="Your BEP-20 Wallet Address" required>
                    <button id="submitWithdrawBtn" class="btn btn-primary w-full py-3 rounded-lg font-bold text-lg">Request Withdrawal</button>
                    <p class="text-base text-gray-500 mt-2">Withdrawals are processed once a month and take 3 days to complete after approval.</p>
                    <div id="withdrawalTimerDisplay" class="hidden mt-4 text-center">
                        <p class="text-xl text-gray-100">Withdrawal completion in:</p>
                        <p class="text-3xl font-bold text-green-400" id="withdrawalTimer">00 Days 00 Hrs 00 Mins</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Referrals & History -->
            <div class="md:col-span-1 space-y-8">
                <!-- User Referral Panel -->
                <div id="userReferralPanel" class="card gradient-blue-purple">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Your Referral Network</h3>
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xl text-gray-100">Current Direct Referrals:</p>
                        <p class="text-4xl font-bold text-yellow-400" id="currentDirectReferrals">0</p>
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xl text-gray-100">Referrals to Next Level:</p>
                        <p class="text-4xl font-bold text-blue-400" id="referralsToNextLevel">N/A</p>
                    </div>
                    <h4 class="text-xl font-semibold mb-2 text-blue-300">Your Referral Code:</h4>
                    <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between mb-4">
                        <span class="font-mono text-base break-all text-yellow-300" id="userReferralCode"></span>
                        <button onclick="copyToClipboard(document.getElementById('userReferralCode').textContent)" class="ml-2 p-2 bg-blue-500 rounded-md text-white hover:bg-blue-600 transition-colors">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <h4 class="text-xl font-semibold mb-2 text-blue-300">Your Referred Users:</h4>
                    <ul id="referredUsersList" class="list-disc list-inside text-gray-100 text-base space-y-1 custom-scrollbar max-h-40 overflow-y-auto">
                        <!-- Referred users will be listed here -->
                        <li class="text-gray-500">No referrals yet. Share your code!</li>
                    </ul>
                </div>

                <!-- Change Withdrawal Address Panel -->
                <div id="changeWithdrawalAddressPanel" class="card gradient-green-cyan">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Change Withdrawal BEP-20 Address</h3>
                    <p class="text-xl text-gray-100 mb-2">Enter your primary BEP-20 address:</p>
                    <input type="text" id="newPrimaryWithdrawalAddressInput" class="input-field w-full py-2 px-3 mb-2 text-xl" placeholder="Your BEP-20 Address (Copy & Paste)">
                    <button id="setPrimaryWithdrawalAddressBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mb-4">Set as Primary</button>
                </div>

                <div id="transactionHistoryPanel" class="card gradient-orange-red">
                    <h3 class="text-xl font-semibold mb-3 text-blue-300">Transaction History</h3>
                    <div id="transactionHistory" class="space-y-2 text-base custom-scrollbar max-h-60 overflow-y-auto">
                        <!-- Transactions will be listed here -->
                        <p class="text-gray-500">No transactions yet.</p>
                    </div>
                </div>

                <!-- New: Staking Level Details Panel -->
                <div id="levelDetailsPanel" class="card gradient-indigo-fuchsia">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">Staking Level Details</h3>
                    <div id="levelDetailsList" class="space-y-3 custom-scrollbar max-h-60 overflow-y-auto">
                        <!-- Level details will be dynamically loaded here -->
                        <p class="text-gray-500">Loading level details...</p>
                    </div>
                </div>

                <!-- New: Admin Announcements & Tasks Panel (User View) -->
                <div id="userAdminContentPanel" class="card gradient-yellow-pink hidden">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">Admin Announcements & Tasks</h3>
                    <div id="userAdminContentList" class="space-y-4 custom-scrollbar max-h-60 overflow-y-auto">
                        <p class="text-gray-500">No announcements or tasks from admin.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="adminDashboard" class="hidden w-full max-w-6xl glass-panel p-8 rounded-xl shadow-2xl grid grid-cols-1 lg:grid-cols-2 gap-8 transition-opacity duration-500 ease-in-out custom-scrollbar overflow-y-auto max-h-[calc(100vh-160px)]">
            <div class="lg:col-span-2">
                <h2 class="text-3xl font-bold text-purple-400 mb-6 text-center">Admin Panel</h2>
                <p class="text-gray-100 text-base mb-4 text-center">Manage all user deposit, withdrawal, and referral bonus requests.</p>
            </div>

            <!-- Admin Overview -->
            <div class="card gradient-blue-purple lg:col-span-2 mb-6">
                <h3 class="text-xl font-semibold mb-3 text-purple-300">Admin Overview</h3>
                <div class="flex flex-col md:flex-row justify-around items-center space-y-4 md:space-y-0 md:space-x-4">
                    <div class="text-center">
                        <p class="text-lg text-gray-100">Admin Referral Code:</p>
                        <p class="text-2xl font-bold text-yellow-400" id="adminReferralCodeDisplay"></p>
                    </div>
                    <div class="text-center">
                        <p class="text-lg text-gray-100">Admin Level:</p>
                        <p class="text-2xl font-bold text-blue-400">5</p> <!-- Hardcoded Admin Level -->
                    </div>
                    <div class="text-center">
                        <p class="text-lg text-gray-100">System Funds (Admin Balance):</p>
                        <p class="text-2xl font-bold text-green-400" id="adminSystemFundsDisplay">0.00 USDT</p>
                    </div>
                    <div class="text-center">
                        <p class="text-lg text-gray-100">Total Referral Bonuses Paid:</p>
                        <p class="text-2xl font-bold text-orange-400" id="totalReferralBonusesPaid">0.00 USDT</p>
                    </div>
                </div>
                <div class="mt-6 border-t border-gray-700 pt-4">
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">Website Name:</h4>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="adminWebsiteNameInput" class="input-field flex-grow py-2 px-3 text-base" placeholder="Enter new website name">
                        <button id="updateWebsiteNameBtn" class="btn btn-primary px-4 py-2 rounded-lg font-bold">Update Name</button>
                    </div>
                </div>
            </div>

            <!-- Admin Referred Users Panel -->
            <div class="card gradient-yellow-pink lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Admin Referred Users</h3>
                <div id="adminReferredUsersList" class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto">
                    <p class="text-gray-500">No users referred by admin yet.</p>
                </div>
            </div>

            <!-- Deposit Approval Panel -->
            <div class="card gradient-green-cyan lg:col-span-1">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Deposit Requests</h3>
                <div id="depositRequests" class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto">
                    <p class="text-gray-500">No pending deposit requests.</p>
                </div>
            </div>

            <!-- Withdrawal Approval Panel -->
            <div class="card gradient-orange-red lg:col-span-1">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Withdrawal Requests</h3>
                <div id="withdrawalRequests" class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto">
                    <p class="text-gray-500">No pending withdrawal requests.</p>
                </div>
            </div>

            <!-- Admin Funds Management Panel -->
            <div class="card gradient-yellow-pink lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Admin Funds Management</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Admin Deposit -->
                    <div>
                        <h4 class="text-lg font-semibold text-blue-300 mb-2">Deposit to System Funds</h4>
                        <input type="number" id="adminSystemDepositAmount" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="Amount to deposit (USDT)" step="0.01">
                        <button id="adminSystemDepositBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Deposit Funds</button>
                    </div>
                    <!-- Admin Withdrawal -->
                    <div>
                        <h4 class="text-lg font-semibold text-blue-300 mb-2">Withdraw from System Funds</h4>
                        <input type="number" id="adminSystemWithdrawAmount" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="Amount to withdraw (USDT)" step="0.01">
                        <input type="text" id="adminSystemWithdrawAddress" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="Custom BEP-20 Address">
                        <button id="adminSystemWithdrawBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Withdraw Funds</button>
                    </div>
                </div>
            </div>

            <!-- Manage System Deposit Address Panel -->
            <div class="card gradient-indigo-fuchsia lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Manage System Deposit Address</h3>
                <p class="text-base text-gray-100 mb-2">Current Global Deposit Address: <span id="currentGlobalDepositAddress" class="font-mono text-base break-all text-green-300"></span></p>
                <label for="newGlobalDepositAddressInput" class="block text-gray-100 text-base font-bold mb-2">Set New Global Deposit Address:</label>
                <input type="text" id="newGlobalDepositAddressInput" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="Enter new BEP-20 address">
                <button id="setGlobalDepositAddressBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Update Global Address</button>
                <p class="text-sm text-gray-500 mt-2">This address will be shown to all users for deposits.</p>
            </div>

            <!-- Withdrawal Restriction Management Panel -->
            <div class="card gradient-blue-purple lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Withdrawal Restriction Management</h3>
                <p class="text-base text-gray-100 mb-2">Current Restriction: <span id="currentWithdrawalRestrictionDays" class="font-bold text-yellow-300"></span> days from first deposit.</p>
                <label for="newWithdrawalRestrictionDaysInput" class="block text-gray-100 text-base font-bold mb-2">Set New Restriction (Days):</label>
                <input type="number" id="newWithdrawalRestrictionDaysInput" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="e.g., 30 (0 for no restriction)" min="0" step="1">
                <div class="flex space-x-2 mt-2">
                    <button id="updateWithdrawalRestrictionBtn" class="btn btn-primary flex-grow py-2 rounded-lg font-bold text-lg">Update Restriction</button>
                    <button id="removeWithdrawalRestrictionBtn" class="btn btn-secondary flex-grow py-2 rounded-lg font-bold text-lg">Remove Restriction (0 Days)</button>
                </div>
                <p class="text-sm text-gray-500 mt-2">Set to 0 days to disable the restriction.</p>
            </div>

            <!-- New: Restriction Message Management Panel -->
            <div id="restrictionMessageManagementPanel" class="card gradient-orange-red lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Restriction Message Management</h3>
                <div id="adminRestrictionMessagesList" class="space-y-4 custom-scrollbar max-h-60 overflow-y-auto mb-6">
                    <!-- Restriction messages will be dynamically loaded here -->
                    <p class="text-gray-500">No custom restriction messages added yet.</p>
                </div>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-blue-300 mb-3">Add New Restriction Message</h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="newRestrictionMessageType" class="block text-gray-100 text-sm font-bold mb-1">Applies To:</label>
                            <select id="newRestrictionMessageType" class="input-field w-full py-2 px-3 text-base">
                                <option value="deposit">Deposit</option>
                                <option value="withdrawal">Withdrawal</option>
                            </select>
                        </div>
                        <div>
                            <label for="newRestrictionMessageContent" class="block text-gray-100 text-sm font-bold mb-1">Message Content:</label>
                            <textarea id="newRestrictionMessageContent" class="input-field w-full py-2 px-3 text-base h-24" placeholder="Enter the restriction message..."></textarea>
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center text-gray-100">
                                <input type="checkbox" id="newRestrictionMessageActive" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                                <span class="ml-2 text-sm font-bold">Active</span>
                            </label>
                        </div>
                    </div>
                    <button id="addNewRestrictionMessageBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-4">Add New Message</button>
                </div>
            </div>


            <!-- All Users & Wallet Management Panel -->
            <div class="card gradient-blue-purple lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Manage User Wallets</h3>
                <div class="mb-4">
                    <label for="adminUserIdSearch" class="block text-gray-100 text-base font-bold mb-2">Search User by ID or Email:</label>
                    <input type="text" id="adminUserIdSearch" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="Enter User ID or Email">
                    <button id="searchUserBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Search User</button>
                </div>

                <div id="selectedUserWalletPanel" class="hidden border border-gray-600 rounded-lg p-4 mt-4 space-y-3">
                    <h4 class="text-lg font-semibold text-blue-300">Selected User: <span id="selectedUserEmail" class="text-yellow-300"></span> (<span id="selectedUserId" class="font-mono text-base"></span>)</h4>
                    <p class="text-base text-gray-100">Current Balance: <span id="selectedUserBalance" class="font-bold text-green-400 text-lg"></span> USDT</p>
                    <p class="text-base text-gray-100">Primary Withdrawal Address: <span id="selectedUserPrimaryAddress" class="font-mono text-base break-all text-blue-300"></span></p>

                    <div class="mt-4">
                        <label for="adminUpdateUserEmailInput" class="block text-gray-100 text-base font-bold mb-2">Update User Email:</label>
                        <input type="email" id="adminUpdateUserEmailInput" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="New Email Address">
                        <button id="adminUpdateUserEmailBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Update Email</button>
                    </div>

                    <div class="mt-4">
                        <label for="adminUpdateWithdrawalAddress" class="block text-gray-100 text-base font-bold mb-2">Update Primary Withdrawal Address:</label>
                        <input type="text" id="adminUpdateWithdrawalAddress" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="New BEP-20 Address">
                        <button id="adminSetWithdrawalAddressBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Update Address</button>
                    </div>

                    <div class="mt-4">
                        <label for="adminAdjustBalanceAmount" class="block text-gray-100 text-base font-bold mb-2">Adjust User Balance (USDT):</label>
                        <input type="number" id="adminAdjustBalanceAmount" class="input-field w-full py-2 px-3 mb-2 text-base" placeholder="Amount (e.g., 100 or -50)" step="0.01">
                        <button id="adminAdjustBalanceBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg">Apply Adjustment</button>
                    </div>

                    <div class="mt-4">
                        <label for="adminSetUserLevel" class="block text-gray-100 text-base font-bold mb-2">Set User Level:</label>
                        <select id="adminSetUserLevel" class="input-field w-full py-2 px-3 text-base">
                            <!-- Options populated dynamically -->
                        </select>
                        <button id="adminApplyUserLevelBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-2">Apply Level</button>
                    </div>
                </div>

                <div id="allUsersList" class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto mt-6">
                    <h4 class="text-lg font-semibold mb-2 text-purple-300">All Registered Users:</h4>
                    <p class="text-gray-500">No users registered.</p>
                </div>
            </div>

            <!-- Admin Level Management Panel -->
            <div id="adminLevelManagementPanel" class="card gradient-yellow-pink lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Manage Staking Levels</h3>
                <div id="levelConfigList" class="space-y-4 custom-scrollbar max-h-96 overflow-y-auto mb-6">
                    <!-- Level configurations will be dynamically loaded here -->
                    <p class="text-gray-500">Loading level configurations...</p>
                </div>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-blue-300 mb-3">Add New Level</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="newLevelNumber" class="block text-gray-100 text-sm font-bold mb-1">Level Number:</label>
                            <input type="number" id="newLevelNumber" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., 6" min="0" step="1">
                        </div>
                        <div>
                            <label for="newLevelInterest" class="block text-gray-100 text-sm font-bold mb-1">Daily Interest Rate (%):</label>
                            <input type="number" id="newLevelInterest" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., 0.10 (for 10%)" min="0" step="0.001">
                        </div>
                        <div>
                            <label for="newLevelMinBalance" class="block text-gray-100 text-sm font-bold mb-1">Min USDT Balance:</label>
                            <input type="number" id="newLevelMinBalance" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., 20000" min="0" step="1">
                        </div>
                        <div>
                            <label for="newLevelReferrals" class="block text-gray-100 text-sm font-bold mb-1">Direct Referrals Needed:</label>
                            <input type="number" id="newLevelReferrals" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., 70" min="0" step="1">
                        </div>
                        <div class="md:col-span-2">
                            <label for="newLevelWithdrawalLimit" class="block text-gray-100 text-sm font-bold mb-1">Monthly Withdrawal Limit (USDT):</label>
                            <input type="number" id="newLevelWithdrawalLimit" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., 1500" min="0" step="1">
                        </div>
                    </div>
                    <button id="addNewLevelBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-4">Add New Level</button>
                </div>
            </div>

            <!-- New: Admin Content Management Panel -->
            <div id="adminContentManagementPanel" class="card gradient-green-cyan lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Manage User Content & Dashboard Panels</h3>
                <div id="adminContentList" class="space-y-4 custom-scrollbar max-h-60 overflow-y-auto mb-6">
                    <!-- Admin managed content will be dynamically loaded here -->
                    <p class="text-gray-500">No custom content added yet.</p>
                </div>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-blue-300 mb-3">Add New Content/Task</h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="newContentTitle" class="block text-gray-100 text-sm font-bold mb-1">Title:</label>
                            <input type="text" id="newContentTitle" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., Important Announcement">
                        </div>
                        <div>
                            <label for="newContentBody" class="block text-gray-100 text-sm font-bold mb-1">Content/Instructions:</label>
                            <textarea id="newContentBody" class="input-field w-full py-2 px-3 text-base h-24" placeholder="Detailed message or task instructions..."></textarea>
                        </div>
                        <div>
                            <label for="newContentType" class="block text-gray-100 text-sm font-bold mb-1">Type:</label>
                            <select id="newContentType" class="input-field w-full py-2 px-3 text-base">
                                <option value="Announcement">Announcement</option>
                                <option value="Action Item">Action Item</option>
                                <option value="Information">Information</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center text-gray-100">
                                <input type="checkbox" id="newContentGlobal" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                                <span class="ml-2 text-sm font-bold">Global (All Users)</span>
                            </label>
                            <div class="flex-grow">
                                <label for="newContentTargetUser" class="block text-gray-100 text-sm font-bold mb-1">Target User ID (Optional):</label>
                                <input type="text" id="newContentTargetUser" class="input-field w-full py-2 px-3 text-base" placeholder="Specific User ID if not global">
                            </div>
                        </div>
                    </div>
                    <button id="addNewContentBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-4">Add New Content</button>
                </div>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-blue-300 mb-3">Manage Dashboard Panel Visibility</h4>
                    <div id="dashboardPanelVisibilityControls" class="space-y-3">
                        <!-- Panel visibility controls will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- New: Website UI Settings Panel -->
            <div id="websiteUISettingsPanel" class="card gradient-indigo-fuchsia lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Website UI Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="themeSelector" class="block text-gray-100 text-sm font-bold mb-1">Select Theme:</label>
                        <select id="themeSelector" class="input-field w-full py-2 px-3 text-base">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="fontSelector" class="block text-gray-100 text-sm font-bold mb-1">Primary Font Family:</label>
                        <select id="fontSelector" class="input-field w-full py-2 px-3 text-base">
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Open Sans', sans-serif">Open Sans</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Lato', sans-serif">Lato</option>
                            <option value="'Poppins', sans-serif">Poppins</option>
                        </select>
                    </div>
                    <div>
                        <label for="baseFontSizeInput" class="block text-gray-100 text-sm font-bold mb-1">Base Font Size (px):</label>
                        <input type="number" id="baseFontSizeInput" class="input-field w-full py-2 px-3 text-base" min="10" max="24" step="1">
                    </div>
                    <div>
                        <label for="panelOpacityInput" class="block text-gray-100 text-sm font-bold mb-1">Panel Background Opacity (0-1):</label>
                        <input type="number" id="panelOpacityInput" class="input-field w-full py-2 px-3 text-base" min="0" max="1" step="0.01">
                    </div>
                    <div>
                        <label for="panelBorderRadiusInput" class="block text-gray-100 text-sm font-bold mb-1">Panel Border Radius (px):</label>
                        <input type="number" id="panelBorderRadiusInput" class="input-field w-full py-2 px-3 text-base" min="0" max="30" step="1">
                    </div>
                    <div>
                        <label for="iconSizeInput" class="block text-gray-100 text-sm font-bold mb-1">Icon Size (em):</label>
                        <input type="number" id="iconSizeInput" class="input-field w-full py-2 px-3 text-base" min="0.5" max="2" step="0.1">
                    </div>
                    <div>
                        <label for="headingColorInput" class="block text-gray-100 text-sm font-bold mb-1">Heading Color:</label>
                        <input type="color" id="headingColorInput" class="input-field w-full h-10 px-1 text-base">
                    </div>
                    <div>
                        <label for="primaryTextColorInput" class="block text-gray-100 text-sm font-bold mb-1">Primary Text Color:</label>
                        <input type="color" id="primaryTextColorInput" class="input-field w-full h-10 px-1 text-base">
                    </div>
                    <div class="md:col-span-2">
                        <label for="panelBaseBackgroundColorInput" class="block text-gray-100 text-sm font-bold mb-1">Panel Base Background Color (for opacity blend):</label>
                        <input type="color" id="panelBaseBackgroundColorInput" class="input-field w-full h-10 px-1 text-base">
                    </div>
                </div>
                <button id="applyUISettingsBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-4">Apply UI Settings</button>
            </div>

            <!-- New: Start Screen Customization Panel -->
            <div id="startScreenCustomizationPanel" class="card gradient-yellow-pink lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4 text-purple-300">Start Screen Customization</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="startScreenTitleInput" class="block text-gray-100 text-sm font-bold mb-1">Title:</label>
                        <input type="text" id="startScreenTitleInput" class="input-field w-full py-2 px-3 text-base" placeholder="Staking Hub">
                    </div>
                    <div>
                        <label for="startScreenSubtitleInput" class="block text-gray-100 text-sm font-bold mb-1">Subtitle:</label>
                        <input type="text" id="startScreenSubtitleInput" class="input-field w-full py-2 px-3 text-base" placeholder="Unlock Your Financial Potential...">
                    </div>
                    <div>
                        <label for="startScreenTitleFontSizeInput" class="block text-gray-100 text-sm font-bold mb-1">Title Font Size (rem):</label>
                        <input type="number" id="startScreenTitleFontSizeInput" class="input-field w-full py-2 px-3 text-base" min="1" max="10" step="0.1">
                    </div>
                    <div>
                        <label for="startScreenSubtitleFontSizeInput" class="block text-gray-100 text-sm font-bold mb-1">Subtitle Font Size (rem):</label>
                        <input type="number" id="startScreenSubtitleFontSizeInput" class="input-field w-full py-2 px-3 text-base" min="0.5" max="5" step="0.1">
                    </div>
                    <div>
                        <label for="startScreenPanelPaddingInput" class="block text-gray-100 text-sm font-bold mb-1">Panel Padding (rem):</label>
                        <input type="number" id="startScreenPanelPaddingInput" class="input-field w-full py-2 px-3 text-base" min="0.5" max="5" step="0.1">
                    </div>
                    <div>
                        <label for="startScreenThemeSelector" class="block text-gray-100 text-sm font-bold mb-1">Apply Theme:</label>
                        <select id="startScreenThemeSelector" class="input-field w-full py-2 px-3 text-base">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <label class="flex items-center text-gray-100">
                            <input type="checkbox" id="showGetStartedButtonCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="ml-2 text-sm font-bold">Show "Get Started" Button</span>
                        </label>
                    </div>
                </div>
                <button id="applyStartScreenSettingsBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-4">Apply Start Screen Settings</button>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-blue-300 mb-3">Custom Content for Start Screen</h4>
                    <div id="startScreenCustomContentList" class="space-y-4 custom-scrollbar max-h-40 overflow-y-auto mb-6">
                        <!-- Custom content items will be loaded here -->
                        <p class="text-gray-500">No custom content added yet.</p>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="newStartScreenContentTitle" class="block text-gray-100 text-sm font-bold mb-1">Content Title (Optional):</label>
                            <input type="text" id="newStartScreenContentTitle" class="input-field w-full py-2 px-3 text-base" placeholder="e.g., Important Note">
                        </div>
                        <div>
                            <label for="newStartScreenContentBody" class="block text-gray-100 text-sm font-bold mb-1">Content Text:</label>
                            <textarea id="newStartScreenContentBody" class="input-field w-full py-2 px-3 text-base h-20" placeholder="Enter custom text for the start screen..."></textarea>
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center text-gray-100">
                                <input type="checkbox" id="newStartScreenContentActive" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                                <span class="ml-2 text-sm font-bold">Active</span>
                            </label>
                        </div>
                    </div>
                    <button id="addStartScreenContentBtn" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-4">Add Custom Content</button>
                </div>
            </div>

        </section>

    </main>

    <script>
        // --- Global Variables and Constants ---
        let RECHARGE_ADDRESS = "0x4D26340f3B52DCf82dd537cBF3c7e4C1D9b53BDc"; // Made mutable
        const ADMIN_EMAIL = "admin@stakinghub.com";
        const ADMIN_PASSWORD = "admin123";
        const ADMIN_REFERRAL_CODE = "ADMINREF";
        const MIN_WITHDRAWAL_AMOUNT = 100;
        const REFERRAL_BONUS = 5; // USDT
        const ONE_DAY_MS = 24 * 60 * 60 * 1000; // Milliseconds in a day
        const ONE_HOUR_MS = 60 * 60 * 1000;
        const ONE_MINUTE_MS = 60 * 1000;
        const ONE_SECOND_MS = 1000;


        // Withdrawal restriction period (in days) - now mutable and saved
        let WITHDRAWAL_LOCK_PERIOD_DAYS = 45; // Default value

        // Level configurations - now mutable
        let LEVELS = {
            0: { interest: 0, minBalance: 0, directReferrals: 0, withdrawalLimit: 0 },
            1: { interest: 0.018, minBalance: 100, directReferrals: 0, withdrawalLimit: 150 }, // 1.8%
            2: { interest: 0.03, minBalance: 800, directReferrals: 8, withdrawalLimit: 300 },   // 3%
            3: { interest: 0.05, minBalance: 2000, directReferrals: 20, withdrawalLimit: 500 },  // 5%
            4: { interest: 0.07, minBalance: 8000, directReferrals: 36, withdrawalLimit: 750 },  // 7%
            5: { interest: 0.09, minBalance: 16000, directReferrals: 55, withdrawalLimit: 1000 } // 9%
        };

        // Theme configurations
        const THEMES = {
            "Abstract Crystal": {
                '--animated-bg-gradient': 'radial-gradient(circle at center, #1a202c, #0f172a)',
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(0, 0, 30, 0.7), rgba(20, 0, 50, 0.7))',
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(0, 30, 0, 0.7), rgba(0, 30, 30, 0.7))',
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(30, 10, 0, 0.7), rgba(30, 0, 0, 0.7))',
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(30, 20, 0, 0.7), rgba(30, 0, 15, 0.7))',
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(10, 15, 30, 0.7), rgba(20, 0, 20, 0.7))',
                '--button-primary-gradient-start': '#63b3ed',
                '--button-primary-gradient-end': '#4299e1',
                '--button-primary-hover-gradient-start': '#4299e1',
                '--button-primary-hover-gradient-end': '#63b3ed',
            },
            "Vibrant Sunset": {
                '--animated-bg-gradient': 'radial-gradient(circle at center, #FF8C00, #FF4500)', /* DarkOrange to OrangeRed */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(139, 0, 0, 0.7), rgba(178, 34, 34, 0.7))', /* DarkRed to Firebrick */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(255, 140, 0, 0.7), rgba(255, 69, 0, 0.7))', /* DarkOrange to OrangeRed */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(255, 99, 71, 0.7), rgba(220, 20, 60, 0.7))', /* Tomato to Crimson */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(255, 215, 0, 0.7), rgba(255, 105, 180, 0.7))', /* Gold to HotPink */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(75, 0, 130, 0.7), rgba(199, 21, 133, 0.7))', /* Indigo to MediumVioletRed */
                '--button-primary-gradient-start': '#FF4500',
                '--button-primary-gradient-end': '#FF8C00',
                '--button-primary-hover-gradient-start': '#FF8C00',
                '--button-primary-hover-gradient-end': '#FF4500',
            },
            "Deep Ocean": {
                '--animated-bg-gradient': 'radial-gradient(circle at center, #000080, #000033)', /* Navy to very dark blue */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(0, 0, 128, 0.7), rgba(25, 25, 112, 0.7))', /* Navy to MidnightBlue */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(0, 50, 50, 0.7), rgba(0, 100, 100, 0.7))', /* DarkCyan to Teal */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(0, 0, 139, 0.7), rgba(0, 0, 205, 0.7))', /* DarkBlue to MediumBlue */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(0, 0, 100, 0.7), rgba(0, 0, 70, 0.7))', /* Deeper blues */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(0, 0, 150, 0.7), rgba(0, 0, 180, 0.7))', /* Deeper blues */
                '--button-primary-gradient-start': '#1E90FF',
                '--button-primary-gradient-end': '#4682B4',
                '--button-primary-hover-gradient-start': '#4682B4',
                '--button-primary-hover-gradient-end': '#1E90FF',
            },
            "Forest Mist": {
                '--animated-bg-gradient': 'radial-gradient(circle at center, #2F4F4F, #0A2A2A)', /* DarkSlateGray to very dark green */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(34, 139, 34, 0.7), rgba(60, 179, 113, 0.7))', /* ForestGreen to MediumSeaGreen */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(46, 139, 87, 0.7), rgba(32, 178, 170, 0.7))', /* SeaGreen to LightSeaGreen */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(85, 107, 47, 0.7), rgba(107, 142, 35, 0.7))', /* DarkOliveGreen to OliveDrab */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(128, 128, 0, 0.7), rgba(154, 205, 50, 0.7))', /* Olive to YellowGreen */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(72, 61, 139, 0.7), rgba(106, 90, 205, 0.7))', /* DarkSlateBlue to MediumSlateBlue */
                '--button-primary-gradient-start': '#3CB371', /* MediumSeaGreen */
                '--button-primary-gradient-end': '#2E8B57', /* SeaGreen */
                '--button-primary-hover-gradient-start': '#2E8B57',
                '--button-primary-hover-gradient-end': '#3CB371',
            },
            "Solar Flare": {
                '--animated-bg-gradient': 'radial-gradient(circle at center, #FF4500, #8B0000)', /* OrangeRed to DarkRed */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(255, 165, 0, 0.7), rgba(255, 99, 71, 0.7))', /* Orange to Tomato */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(255, 140, 0, 0.7), rgba(255, 69, 0, 0.7))', /* DarkOrange to OrangeRed */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(220, 20, 60, 0.7), rgba(178, 34, 34, 0.7))', /* Crimson to Firebrick */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(255, 215, 0, 0.7), rgba(255, 192, 203, 0.7))', /* Gold to Pink */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(139, 0, 0, 0.7), rgba(199, 21, 133, 0.7))', /* DarkRed to MediumVioletRed */
                '--button-primary-gradient-start': '#FFD700', /* Gold */
                '--button-primary-gradient-end': '#FF8C00', /* DarkOrange */
                '--button-primary-hover-gradient-start': '#FF8C00',
                '--button-primary-hover-gradient-end': '#FFD700',
            },
            "Midnight Sky": {
                '--animated-bg-gradient': 'radial-gradient(circle at center, #191970, #000000)', /* MidnightBlue to Black */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(25, 25, 112, 0.7), rgba(72, 61, 139, 0.7))', /* MidnightBlue to DarkSlateBlue */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(0, 0, 128, 0.7), rgba(0, 0, 205, 0.7))', /* Navy to MediumBlue */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(65, 105, 225, 0.7), rgba(100, 149, 237, 0.7))', /* RoyalBlue to CornflowerBlue */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(70, 130, 180, 0.7), rgba(106, 90, 205, 0.7))', /* SteelBlue to MediumSlateBlue */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(138, 43, 226, 0.7), rgba(147, 112, 219, 0.7))', /* BlueViolet to MediumPurple */
                '--button-primary-gradient-start': '#4169E1', /* RoyalBlue */
                '--button-primary-gradient-end': '#6A5ACD', /* SlateBlue */
                '--button-primary-hover-gradient-start': '#6A5ACD',
                '--button-primary-hover-gradient-end': '#4169E1',
            },
            "Emerald Dream": { /* New Theme */
                '--animated-bg-gradient': 'radial-gradient(circle at center, #004d40, #00251a)', /* Dark Teal to very dark green */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(0, 100, 0, 0.7), rgba(0, 128, 0, 0.7))', /* DarkGreen to Green */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(0, 150, 0, 0.7), rgba(0, 200, 0, 0.7))', /* Brighter Greens */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(0, 80, 80, 0.7), rgba(0, 120, 120, 0.7))', /* Dark Cyan */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(50, 150, 50, 0.7), rgba(80, 180, 80, 0.7))', /* Lighter Greens */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(0, 60, 0, 0.7), rgba(0, 90, 0, 0.7))', /* Even Darker Greens */
                '--button-primary-gradient-start': '#008000', /* Green */
                '--button-primary-gradient-end': '#228B22', /* ForestGreen */
                '--button-primary-hover-gradient-start': '#228B22',
                '--button-primary-hover-gradient-end': '#008000',
            },
            "Crimson Night": { /* New Theme */
                '--animated-bg-gradient': 'radial-gradient(circle at center, #330000, #000000)', /* Dark Red to Black */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(100, 0, 0, 0.7), rgba(150, 0, 0, 0.7))', /* Dark Reds */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(120, 0, 0, 0.7), rgba(180, 0, 0, 0.7))', /* Brighter Reds */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(150, 0, 0, 0.7), rgba(200, 0, 0, 0.7))', /* Even Brighter Reds */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(80, 0, 0, 0.7), rgba(120, 0, 0, 0.7))', /* Deeper Reds */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(60, 0, 0, 0.7), rgba(90, 0, 0, 0.7))', /* Darkest Reds */
                '--button-primary-gradient-start': '#8B0000', /* DarkRed */
                '--button-primary-gradient-end': '#DC143C', /* Crimson */
                '--button-primary-hover-gradient-start': '#DC143C',
                '--button-primary-hover-gradient-end': '#8B0000',
            },
            "Lavender Haze": { /* New Theme */
                '--animated-bg-gradient': 'radial-gradient(circle at center, #4B0082, #2A004D)', /* Indigo to Dark Purple */
                '--card-gradient-blue-purple': 'linear-gradient(135deg, rgba(138, 43, 226, 0.7), rgba(147, 112, 219, 0.7))', /* BlueViolet to MediumPurple */
                '--card-gradient-green-cyan': 'linear-gradient(135deg, rgba(186, 85, 211, 0.7), rgba(218, 112, 214, 0.7))', /* MediumOrchid to Orchid */
                '--card-gradient-orange-red': 'linear-gradient(135deg, rgba(128, 0, 128, 0.7), rgba(153, 50, 204, 0.7))', /* Purple to DarkOrchid */
                '--card-gradient-yellow-pink': 'linear-gradient(135deg, rgba(238, 130, 238, 0.7), rgba(255, 192, 203, 0.7))', /* Violet to Pink */
                '--card-gradient-indigo-fuchsia': 'linear-gradient(135deg, rgba(106, 90, 205, 0.7), rgba(123, 104, 238, 0.7))', /* MediumSlateBlue to SlateBlue */
                '--button-primary-gradient-start': '#8A2BE2', /* BlueViolet */
                '--button-primary-gradient-end': '#9370DB', /* MediumPurple */
                '--button-primary-hover-gradient-start': '#9370DB',
                '--button-primary-hover-gradient-end': '#8A2BE2',
            }
        };

        // Default UI Settings (can be overridden by themes or user preferences)
        let uiSettings = {
            'font-family-primary': "'Inter', sans-serif",
            'font-size-base': '16px',
            'panel-bg-opacity': '0.08',
            'panel-border-radius': '12px',
            'text-color-primary': '#FFFFFF',
            'text-color-secondary': '#e2e8f0',
            'text-color-heading': '#63b3ed',
            'icon-size': '1em',
            'panel-base-background-color': '#FFFFFF', // New: Base color for panel background
        };

        // Default Start Screen Settings
        let startScreenSettings = {
            title: "Staking Hub",
            subtitle: "Unlock Your Financial Potential. Securely stake USDT and earn daily rewards.",
            titleFontSize: '3rem',
            subtitleFontSize: '1.25rem',
            panelPadding: '1rem',
            showGetStartedButton: true,
            customContent: [] // Array for custom text blocks on start screen
        };

        // Default visibility for user dashboard panels
        let dashboardPanelVisibility = {
            userOverviewPanel: true,
            userLevelPanel: true,
            dailyInterestPanel: true,
            rechargePanel: true,
            withdrawPanel: true,
            userReferralPanel: true,
            changeWithdrawalAddressPanel: true,
            transactionHistoryPanel: true,
            levelDetailsPanel: true,
            userAdminContentPanel: true,
        };


        let currentWebsiteName = "Staking Hub"; // Default website name
        let currentThemeName = "Abstract Crystal"; // Default theme

        let currentUser = null; // Stores the currently logged-in user object
        let isAdmin = false;
        let selectedAdminUser = null; // Used in admin panel to store the user being managed
        let systemFunds = 1000000; // Tracks the system's own funds (initialized to max possible for testing)

        // Admin Managed Content (Tasks/Panels)
        let adminManagedContent = []; // Array to store dynamic content for users
        // Admin Managed Restriction Messages
        let adminRestrictionMessages = []; // Array to store custom restriction messages

        let isInitialLoad = true; // Flag to prevent UI settings message on startup

        // --- DOM Elements ---
        const websiteTitleElem = document.getElementById('websiteTitle');
        const startScreenTitleElem = document.getElementById('startScreenTitle'); // For start screen title
        const startScreenSubtitleElem = document.getElementById('startScreenSubtitle'); // For start screen subtitle
        const startScreenPanelElem = document.getElementById('startScreenPanel'); // For start screen panel padding
        const startScreenCustomContentElem = document.getElementById('startScreenCustomContent'); // For custom content on start screen

        const startScreen = document.getElementById('startScreen');
        const signUpFormSection = document.getElementById('signUpForm');
        const signInFormSection = document.getElementById('signInForm');
        const userDashboardSection = document.getElementById('userDashboard');
        const adminDashboardSection = document.getElementById('adminDashboard');

        const showSignInBtn = document.getElementById('showSignInBtn');
        const showSignUpBtn = document.getElementById('showSignUpBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const getStartedBtn = document.getElementById('getStartedBtn');

        const signUpForm = document.getElementById('signUp');
        const signInForm = document.getElementById('signIn');

        const linkToSignIn = document.getElementById('linkToSignIn');
        const linkToSignUp = document.getElementById('linkToSignUp');

        const totalUsdtBalanceElem = document.getElementById('totalUsdtBalance');
        const dashboardUserIdElem = document.getElementById('dashboardUserId');
        const currentLevelBadgeElem = document.getElementById('currentLevelBadge');
        const interestRateElem = document.getElementById('interestRate');
        const minBalanceElem = document.getElementById('minBalance');
        const monthlyWithdrawalLimitElem = document.getElementById('monthlyWithdrawalLimit');

        const rechargeAddressElem = document.getElementById('rechargeAddress');
        const rechargeAmountInput = document.getElementById('rechargeAmount');
        const submitRechargeBtn = document.getElementById('submitRechargeBtn');
        const depositRestrictionMessagesElem = document.getElementById('depositRestrictionMessages'); // New

        const withdrawAmountInput = document.getElementById('withdrawAmount');
        const withdrawAddressInput = document = document.getElementById('withdrawAddress');
        const submitWithdrawBtn = document.getElementById('submitWithdrawBtn');
        const withdrawalTimerDisplayElem = document.getElementById('withdrawalTimerDisplay');
        const withdrawalTimerElem = document.getElementById('withdrawalTimer');
        const withdrawalRestrictionMessagesElem = document.getElementById('withdrawalRestrictionMessages'); // New

        const userReferralCodeElem = document.getElementById('userReferralCode');
        const referredUsersListElem = document.getElementById('referredUsersList');
        const transactionHistoryElem = document.getElementById('transactionHistory');

        // User Withdrawal Address Panel Elements (simplified)
        const newPrimaryWithdrawalAddressInput = document.getElementById('newPrimaryWithdrawalAddressInput');
        const setPrimaryWithdrawalAddressBtn = document.getElementById('setPrimaryWithdrawalAddressBtn');

        // User Referral Panel Elements
        const currentDirectReferralsElem = document.getElementById('currentDirectReferrals');
        const referralsToNextLevelElem = document.getElementById('referralsToNextLevel');

        // Daily Interest Timer Element
        const dailyInterestTimerElem = document.getElementById('dailyInterestTimer');
        const dailyInterestMessageElem = document.getElementById('dailyInterestMessage');

        // New Level Details Panel Element
        const levelDetailsListElem = document.getElementById('levelDetailsList');

        // User Admin Content Panel
        const userAdminContentPanel = document.getElementById('userAdminContentPanel');
        const userAdminContentList = document.getElementById('userAdminContentList');


        const adminReferralCodeDisplay = document.getElementById('adminReferralCodeDisplay');
        const totalAdminReferralsElem = document.getElementById('totalAdminReferrals');
        const adminSystemFundsDisplay = document.getElementById('adminSystemFundsDisplay'); // New element
        const totalReferralBonusesPaidElem = document.getElementById('totalReferralBonusesPaid');
        const depositRequestsElem = document.getElementById('depositRequests');
        const withdrawalRequestsElem = document.getElementById('withdrawalRequests');
        const totalUsdtInCirculationElem = document.getElementById('totalUsdtInCirculation'); // Still needed for overall circulation

        // Admin User Wallet Management Elements
        const adminUserIdSearch = document.getElementById('adminUserIdSearch');
        const searchUserBtn = document.getElementById('searchUserBtn');
        const selectedUserWalletPanel = document.getElementById('selectedUserWalletPanel');
        const selectedUserEmailElem = document.getElementById('selectedUserEmail');
        const selectedUserIdElem = document.getElementById('selectedUserId');
        const selectedUserBalanceElem = document.getElementById('selectedUserBalance');
        const selectedUserPrimaryAddressElem = document.getElementById('selectedUserPrimaryAddress');
        const adminUpdateUserEmailInput = document.getElementById('adminUpdateUserEmailInput');
        const adminUpdateUserEmailBtn = document.getElementById('adminUpdateUserEmailBtn');
        const adminUpdateWithdrawalAddressInput = document.getElementById('adminUpdateWithdrawalAddress');
        const adminSetWithdrawalAddressBtn = document.getElementById('adminSetWithdrawalAddressBtn');
        const adminAdjustBalanceAmountInput = document.getElementById('adminAdjustBalanceAmount');
        const adminAdjustBalanceBtn = document.getElementById('adminAdjustBalanceBtn');
        const adminSetUserLevelSelect = document.getElementById('adminSetUserLevel'); // New element
        const adminApplyUserLevelBtn = document.getElementById('adminApplyUserLevelBtn'); // New element
        const allUsersListElem = document.getElementById('allUsersList');

        // Admin Funds Management Elements
        const adminSystemDepositAmountInput = document.getElementById('adminSystemDepositAmount');
        const adminSystemDepositBtn = document.getElementById('adminSystemDepositBtn');
        const adminSystemWithdrawAmountInput = document.getElementById('adminSystemWithdrawAmount');
        const adminSystemWithdrawAddressInput = document.getElementById('adminSystemWithdrawAddress');
        const adminSystemWithdrawBtn = document = document.getElementById('adminSystemWithdrawBtn');

        // New Admin Global Deposit Address Elements
        const currentGlobalDepositAddressElem = document.getElementById('currentGlobalDepositAddress');
        const newGlobalDepositAddressInput = document.getElementById('newGlobalDepositAddressInput');
        const setGlobalDepositAddressBtn = document.getElementById('setGlobalDepositAddressBtn');

        // Admin Level Management DOM Elements
        const adminLevelManagementPanel = document.getElementById('adminLevelManagementPanel');
        const levelConfigList = document.getElementById('levelConfigList');
        const newLevelNumberInput = document.getElementById('newLevelNumber');
        const newLevelInterestInput = document.getElementById('newLevelInterest');
        const newLevelMinBalanceInput = document.getElementById('newLevelMinBalance');
        const newLevelReferralsInput = document.getElementById('newLevelReferrals');
        const newLevelWithdrawalLimitInput = document.getElementById('newLevelWithdrawalLimit');
        const addNewLevelBtn = document.getElementById('addNewLevelBtn');

        // Admin Website Name Elements
        const adminWebsiteNameInput = document.getElementById('adminWebsiteNameInput');
        const updateWebsiteNameBtn = document.getElementById('updateWebsiteNameBtn');

        // Admin Theme Settings Elements
        const themeSelector = document.getElementById('themeSelector');
        const fontSelector = document.getElementById('fontSelector'); // New
        const baseFontSizeInput = document.getElementById('baseFontSizeInput'); // New
        const panelOpacityInput = document.getElementById('panelOpacityInput'); // New
        const headingColorInput = document.getElementById('headingColorInput'); // New
        const primaryTextColorInput = document.getElementById('primaryTextColorInput'); // New
        const panelBorderRadiusInput = document.getElementById('panelBorderRadiusInput'); // New
        const iconSizeInput = document.getElementById('iconSizeInput'); // New
        const applyUISettingsBtn = document.getElementById('applyUISettingsBtn'); // Renamed
        const panelBaseBackgroundColorInput = document.getElementById('panelBaseBackgroundColorInput'); // New

        // Admin Content Management Elements
        const adminContentManagementPanel = document.getElementById('adminContentManagementPanel');
        const adminContentList = document.getElementById('adminContentList');
        const newContentTitleInput = document.getElementById('newContentTitle');
        const newContentBodyInput = document.getElementById('newContentBody');
        const newContentTypeSelect = document.getElementById('newContentType');
        const newContentGlobalCheckbox = document.getElementById('newContentGlobal');
        const newContentTargetUserInput = document.getElementById('newContentTargetUser');
        const addNewContentBtn = document.getElementById('addNewContentBtn');
        const dashboardPanelVisibilityControls = document.getElementById('dashboardPanelVisibilityControls'); // New

        // Admin Referred Users List
        const adminReferredUsersListElem = document.getElementById('adminReferredUsersList');

        // New Withdrawal Restriction Management Elements
        const currentWithdrawalRestrictionDaysElem = document.getElementById('currentWithdrawalRestrictionDays');
        const newWithdrawalRestrictionDaysInput = document.getElementById('newWithdrawalRestrictionDaysInput');
        const updateWithdrawalRestrictionBtn = document.getElementById('updateWithdrawalRestrictionBtn');
        const removeWithdrawalRestrictionBtn = document.getElementById('removeWithdrawalRestrictionBtn');

        // New Restriction Message Management Elements
        const adminRestrictionMessagesListElem = document.getElementById('adminRestrictionMessagesList');
        const newRestrictionMessageTypeSelect = document.getElementById('newRestrictionMessageType');
        const newRestrictionMessageContentInput = document.getElementById('newRestrictionMessageContent');
        const newRestrictionMessageActiveCheckbox = document.getElementById('newRestrictionMessageActive');
        const addNewRestrictionMessageBtn = document.getElementById('addNewRestrictionMessageBtn');

        // New Start Screen Customization Elements
        const startScreenTitleInput = document.getElementById('startScreenTitleInput');
        const startScreenSubtitleInput = document.getElementById('startScreenSubtitleInput');
        const startScreenTitleFontSizeInput = document.getElementById('startScreenTitleFontSizeInput');
        const startScreenSubtitleFontSizeInput = document.getElementById('startScreenSubtitleFontSizeInput');
        const startScreenPanelPaddingInput = document.getElementById('startScreenPanelPaddingInput');
        const showGetStartedButtonCheckbox = document.getElementById('showGetStartedButtonCheckbox');
        const applyStartScreenSettingsBtn = document.getElementById('applyStartScreenSettingsBtn');
        const startScreenCustomContentListElem = document.getElementById('startScreenCustomContentList');
        const newStartScreenContentTitleInput = document.getElementById('newStartScreenContentTitle');
        const newStartScreenContentBodyInput = document.getElementById('newStartScreenContentBody');
        const newStartScreenContentActiveCheckbox = document.getElementById('newStartScreenContentActive');
        const addStartScreenContentBtn = document.getElementById('addStartScreenContentBtn');
        const startScreenThemeSelector = document.getElementById('startScreenThemeSelector'); // New


        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkButton = document.getElementById('modalOkButton');
        const modalCancelButton = document.getElementById('modalCancelButton');


        let dailyInterestInterval;
        let withdrawalCompletionInterval;

        // Global variables for modal state
        let modalConfirmCallback = null;
        let modalCancelCallback = null; // New: for cancel button
        let modalAutoCloseTimeoutId = null;
        let currentModalIntervalId = null; // To track countdown interval

        // --- Utility Functions ---

        /**
         * Converts a hex color string to RGB components (e.g., "255, 255, 255").
         * @param {string} hex The hex color string (e.g., "#RRGGBB").
         * @returns {string} RGB components as a string.
         */
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `${r}, ${g}, ${b}`;
        }

        /**
         * Displays a custom modal message.
         * @param {string} message The message to display.
         * @param {function} [onConfirm] Optional callback to execute when OK is clicked.
         * @param {function} [onCancel] Optional callback to execute when Cancel is clicked.
         * @param {number} [autoCloseDelay=0] Optional delay in ms after which the modal auto-closes and onConfirm is called.
         * @param {string} [okButtonText='OK'] Optional text for the OK button.
         * @param {string} [cancelButtonText='Cancel'] Optional text for the Cancel button.
         * @param {boolean} [showTimer=false] If true, shows a countdown timer on the OK button.
         */
        function showModal(message, onConfirm = null, onCancel = null, autoCloseDelay = 0, okButtonText = 'OK', cancelButtonText = 'Cancel', showTimer = false) {
            // Clear any existing auto-close timeout or countdown interval
            if (modalAutoCloseTimeoutId) {
                clearTimeout(modalAutoCloseTimeoutId);
                modalAutoCloseTimeoutId = null;
            }
            if (currentModalIntervalId) {
                clearInterval(currentModalIntervalId);
                currentModalIntervalId = null;
            }

            modalMessage.textContent = message;
            modalOkButton.textContent = okButtonText;
            modalOkButton.disabled = false; // Ensure button is enabled

            // Show/hide cancel button and set its text
            if (onCancel) {
                modalCancelButton.classList.remove('hidden');
                modalCancelButton.textContent = cancelButtonText;
                modalCancelButton.disabled = false;
            } else {
                modalCancelButton.classList.add('hidden');
            }

            // Store the callbacks for the modal's buttons
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;

            // Set up the OK button's specific handler for this modal instance
            modalOkButton.onclick = () => {
                if (currentModalIntervalId) {
                    clearInterval(currentModalIntervalId);
                    currentModalIntervalId = null;
                }
                closeModal();
                if (modalConfirmCallback) {
                    const callbackToExecute = modalConfirmCallback;
                    modalConfirmCallback = null;
                    modalCancelCallback = null; // Clear cancel callback too
                    callbackToExecute();
                }
            };

            // Set up the Cancel button's specific handler for this modal instance
            modalCancelButton.onclick = () => {
                if (currentModalIntervalId) {
                    clearInterval(currentModalIntervalId);
                    currentModalIntervalId = null;
                }
                closeModal();
                if (modalCancelCallback) {
                    const callbackToExecute = modalCancelCallback;
                    modalConfirmCallback = null; // Clear confirm callback too
                    modalCancelCallback = null;
                    callbackToExecute();
                }
            };

            // If autoCloseDelay is provided, set a timeout and update button text
            if (autoCloseDelay > 0) {
                let countdown = autoCloseDelay / ONE_SECOND_MS;
                let initialMessage = message; // Store initial message for timer updates

                currentModalIntervalId = setInterval(() => {
                    countdown--;
                    if (showTimer) {
                        // Re-calculate remaining time for the withdrawal restriction message
                        const now = Date.now();
                        const timeSinceFirstDeposit = now - currentUser.firstDepositTime;
                        const withdrawalLockPeriodMs = WITHDRAWAL_LOCK_PERIOD_DAYS * ONE_DAY_MS;
                        const remainingTimeMs = withdrawalLockPeriodMs - timeSinceFirstDeposit;

                        if (remainingTimeMs <= 0) {
                            clearInterval(currentModalIntervalId);
                            currentModalIntervalId = null;
                            modalMessage.textContent = initialMessage.split('Remaining:')[0] + "Restriction lifted!";
                            modalOkButton.textContent = okButtonText;
                            modalOkButton.disabled = false;
                            // No auto-close here, let user click OK
                            return;
                        }

                        const days = Math.floor(remainingTimeMs / ONE_DAY_MS);
                        const hours = Math.floor((remainingTimeMs % ONE_DAY_MS) / ONE_HOUR_MS);
                        const minutes = Math.floor((remainingTimeMs % ONE_HOUR_MS) / ONE_MINUTE_MS);
                        const seconds = Math.floor((remainingTimeMs % ONE_MINUTE_MS) / ONE_SECOND_MS);

                        modalMessage.textContent = `${initialMessage.split('Remaining:')[0]}Remaining: ${String(days).padStart(2, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s.`;
                        modalOkButton.textContent = `${okButtonText} (${countdown}s)`; // Still show modal countdown
                    } else {
                        modalOkButton.textContent = `${okButtonText} (${countdown}s)`;
                    }

                    if (countdown <= 0) {
                        clearInterval(currentModalIntervalId);
                        currentModalIntervalId = null;
                        closeModal();
                        if (modalConfirmCallback) {
                            const callbackToExecute = modalConfirmCallback;
                            modalConfirmCallback = null;
                            modalCancelCallback = null;
                            callbackToExecute();
                        }
                    }
                }, ONE_SECOND_MS);
            }

            messageModal.style.display = 'flex';
        }

        /**
         * Closes the custom modal without executing a callback.
         * Used for the 'X' button.
         */
        function closeModal() {
            messageModal.style.display = 'none';
            // Clear any active countdown interval if modal is closed manually
            if (currentModalIntervalId) {
                clearInterval(currentModalIntervalId);
                currentModalIntervalId = null;
            }
            // Do NOT clear modalConfirmCallback/modalCancelCallback here, as they might be needed by the calling context
            // if closeModal is called directly (e.g., by the 'X' button).
            // The callbacks should only be cleared AFTER they're executed or if a new modal is presented.
        }

        // The 'X' button handler should simply close the modal without triggering the confirm callback
        messageModal.querySelector('.modal-close-button').onclick = closeModal;

        // The OK and Cancel button's handlers are set dynamically within showModal.

        /**
         * Copies text to clipboard.
         * @param {string} textToCopy The text content to copy.
         */
        function copyToClipboard(textToCopy) {
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showModal('Copied to clipboard!');
        }

        /**
         * Generates a unique ID.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /**
         * Saves all users data to local storage.
         * @param {Array<Object>} usersArray The array of user objects.
         */
        function saveUsers(usersArray) {
            localStorage.setItem('stakingHubUsers', JSON.stringify(usersArray));
        }

        /**
         * Loads all users data from local storage.
         * @returns {Array<Object>} An array of user objects, or an empty array if none.
         */
        function loadUsers() {
            const usersJson = localStorage.getItem('stakingHubUsers');
            return usersJson ? JSON.parse(usersJson) : [];
        }

        /**
         * Saves all transactions data to local storage.
         * @param {Array<Object>} transactionsArray The array of transaction objects.
         */
        function saveTransactions(transactionsArray) {
            localStorage.setItem('stakingHubTransactions', JSON.stringify(transactionsArray));
        }

        /**
         * Loads all transactions data from local storage.
         * @returns {Array<Object>} An array of transaction objects, or an empty array if none.
         */
        function loadTransactions() {
            const transactionsJson = localStorage.getItem('stakingHubTransactions');
            return transactionsJson ? JSON.parse(transactionsJson) : [];
        }

        /**
         * Updates a user's data in local storage.
         * @param {Object} updatedUser The user object with updated data.
         */
        function updateUserData(updatedUser) {
            let users = loadUsers();
            const index = users.findIndex(u => u.id === updatedUser.id);
            if (index !== -1) {
                users[index] = updatedUser;
                saveUsers(users);
                if (currentUser && currentUser.id === updatedUser.id) {
                    currentUser = updatedUser; // Update current user if it's the logged-in one
                }
            }
        }

        /**
         * Saves the system funds to local storage.
         */
        function saveSystemFunds() {
            localStorage.setItem('stakingHubSystemFunds', JSON.stringify(systemFunds));
        }

        /**
         * Loads the system funds from local storage.
         * @returns {number} The system funds.
         */
        function loadSystemFunds() {
            const fundsJson = localStorage.getItem('stakingHubSystemFunds');
            // Initialize with 1,000,000 if not set, as requested for admin testing
            return fundsJson ? parseFloat(fundsJson) : 1000000;
        }

        /**
         * Saves admin transactions to local storage.
         * @param {Array<Object>} adminTransactionsArray The array of admin transaction objects.
         */
        function saveAdminTransactions(adminTransactionsArray) {
            localStorage.setItem('stakingHubAdminTransactions', JSON.stringify(adminTransactionsArray));
        }

        /**
         * Loads admin transactions from local storage.
         * @returns {Array<Object>} An array of admin transaction objects, or an empty array if none.
         */
        function loadAdminTransactions() {
            const adminTxJson = localStorage.getItem('stakingHubAdminTransactions');
            return adminTxJson ? JSON.parse(adminTxJson) : [];
        }

        /**
         * Saves the global deposit address to local storage.
         * @param {string} address The new global deposit address.
         */
        function saveGlobalDepositAddress(address) {
            localStorage.setItem('stakingHubGlobalDepositAddress', address);
            RECHARGE_ADDRESS = address; // Update the global variable
        }

        /**
         * Loads the global deposit address from local storage.
         * @returns {string} The global deposit address.
         */
        function loadGlobalDepositAddress() {
            const storedAddress = localStorage.getItem('stakingHubGlobalDepositAddress');
            return storedAddress || "0x4D26340f3B52DCf82dd537cBF3c7e4C1D9b53BDc"; // Default if not set
        }

        /**
         * Saves the LEVELS object to local storage.
         */
        function saveLevelsConfig() {
            localStorage.setItem('stakingHubLevels', JSON.stringify(LEVELS));
        }

        /**
         * Loads the LEVELS object from local storage.
         * If no config is found, it returns the default LEVELS.
         * @returns {Object} The loaded or default LEVELS configuration.
         */
        function loadLevelsConfig() {
            const storedLevels = localStorage.getItem('stakingHubLevels');
            if (storedLevels) {
                // Parse and merge with default to ensure all properties exist for old data
                const parsedLevels = JSON.parse(storedLevels);
                // Ensure all default levels are present and merge properties
                for (const levelKey in LEVELS) {
                    if (!parsedLevels[levelKey]) {
                        parsedLevels[levelKey] = LEVELS[levelKey]; // Add missing default levels
                    } else {
                        // Merge properties for existing levels (useful if new properties are added to default)
                        LEVELS[levelKey] = { ...LEVELS[levelKey], ...parsedLevels[levelKey] };
                    }
                }
                LEVELS = parsedLevels; // Overwrite global LEVELS with loaded/merged data
            }
            // If no storedLevels, LEVELS remains its default value
        }

        /**
         * Saves the current website name to local storage.
         * @param {string} name The new website name.
         */
        function saveWebsiteName(name) {
            localStorage.setItem('stakingHubWebsiteName', name);
            currentWebsiteName = name;
        }

        /**
         * Loads the website name from local storage.
         * @returns {string} The website name.
         */
        function loadWebsiteName() {
            const storedName = localStorage.getItem('stakingHubWebsiteName');
            return storedName || "Staking Hub"; // Default if not set
        }

        /**
         * Saves the current theme name to local storage.
         * @param {string} theme The new theme name.
         */
        function saveThemeName(theme) {
            localStorage.setItem('stakingHubThemeName', theme);
            currentThemeName = theme;
        }

        /**
         * Loads the theme name from local storage.
         * @returns {string} The theme name.
         */
        function loadThemeName() {
            const storedTheme = localStorage.getItem('stakingHubThemeName');
            return storedTheme || "Abstract Crystal"; // Default if not set
        }

        /**
         * Saves current UI settings to local storage.
         */
        function saveUISettings() {
            localStorage.setItem('stakingHubUISettings', JSON.stringify(uiSettings));
        }

        /**
         * Loads UI settings from local storage.
         */
        function loadUISettings() {
            const storedSettings = localStorage.getItem('stakingHubUISettings');
            if (storedSettings) {
                // Merge loaded settings with default to ensure new properties are handled
                uiSettings = { ...uiSettings, ...JSON.parse(storedSettings) };
            }
        }

        /**
         * Applies UI settings (theme, font, font size, opacity, colors, border-radius, icon size)
         * by updating CSS variables.
         * @param {boolean} suppressModal If true, suppresses the "UI settings applied" modal.
         */
        function applyUISettings(suppressModal = false) {
            const root = document.documentElement;

            // Apply selected theme's gradients and button colors
            const theme = THEMES[themeSelector.value];
            if (theme) {
                for (const [prop, value] of Object.entries(theme)) {
                    root.style.setProperty(prop, value);
                }
                saveThemeName(themeSelector.value); // Save the applied theme name
            } else {
                console.warn(`Theme "${themeSelector.value}" not found, applying default gradients.`);
            }

            // Apply general UI settings from the uiSettings object
            // Check if elements exist before accessing their value
            if (fontSelector) uiSettings['font-family-primary'] = fontSelector.value;
            if (baseFontSizeInput) uiSettings['font-size-base'] = `${baseFontSizeInput.value}px`;
            if (panelOpacityInput) uiSettings['panel-bg-opacity'] = panelOpacityInput.value;
            if (panelBorderRadiusInput) uiSettings['panel-border-radius'] = `${panelBorderRadiusInput.value}px`;
            if (headingColorInput) uiSettings['text-color-heading'] = headingColorInput.value;
            if (primaryTextColorInput) uiSettings['text-color-primary'] = primaryTextColorInput.value;
            if (iconSizeInput) uiSettings['icon-size'] = `${iconSizeInput.value}em`;
            if (panelBaseBackgroundColorInput) uiSettings['panel-base-background-color'] = panelBaseBackgroundColorInput.value; // Save the hex value

            // Set the RGB components for the panel background
            root.style.setProperty('--panel-base-background-color-rgb', hexToRgb(uiSettings['panel-base-background-color']));


            for (const [prop, value] of Object.entries(uiSettings)) {
                // Do not re-set gradients as they are handled by theme selection
                if (!prop.startsWith('--card-gradient') && !prop.startsWith('--button-primary-gradient')) {
                    root.style.setProperty(`--${prop}`, value);
                }
            }

            saveUISettings(); // Save updated UI settings
            if (!suppressModal) {
                showModal('UI settings applied successfully!');
            }
        }

        /**
         * Saves dashboard panel visibility settings to local storage.
         */
        function saveDashboardPanelVisibility() {
            localStorage.setItem('stakingHubPanelVisibility', JSON.stringify(dashboardPanelVisibility));
        }

        /**
         * Loads dashboard panel visibility settings from local storage.
         */
        function loadDashboardPanelVisibility() {
            const storedVisibility = localStorage.getItem('stakingHubPanelVisibility');
            if (storedVisibility) {
                // Merge loaded settings with default to ensure new panels are handled
                dashboardPanelVisibility = { ...dashboardPanelVisibility, ...JSON.parse(storedVisibility) };
            }
        }

        /**
         * Saves admin managed content to local storage.
         * @param {Array<Object>} contentArray The array of admin managed content objects.
         */
        function saveAdminContent(contentArray) {
            localStorage.setItem('stakingHubAdminContent', JSON.stringify(contentArray));
        }

        /**
         * Loads admin managed content from local storage.
         * @returns {Array<Object>} An array of admin managed content objects, or an empty array if none.
         */
        function loadAdminContent() {
            const contentJson = localStorage.getItem('stakingHubAdminContent');
            return contentJson ? JSON.parse(contentJson) : [];
        }

        /**
         * Saves the withdrawal restriction days to local storage.
         * @param {number} days The number of days for the restriction.
         */
        function saveWithdrawalRestrictionDays(days) {
            localStorage.setItem('stakingHubWithdrawalRestrictionDays', days.toString());
            WITHDRAWAL_LOCK_PERIOD_DAYS = days; // Update global variable
        }

        /**
         * Loads the withdrawal restriction days from local storage.
         * @returns {number} The number of days for the restriction.
         */
        function loadWithdrawalRestrictionDays() {
            const storedDays = localStorage.getItem('stakingHubWithdrawalRestrictionDays');
            // Default to 45 if not set or invalid
            return storedDays ? parseInt(storedDays) : 45;
        }

        /**
         * Saves admin restriction messages to local storage.
         * @param {Array<Object>} messagesArray The array of restriction message objects.
         */
        function saveRestrictionMessages(messagesArray) {
            localStorage.setItem('stakingHubRestrictionMessages', JSON.stringify(messagesArray));
        }

        /**
         * Loads admin restriction messages from local storage.
         * @returns {Array<Object>} An array of restriction message objects, or an empty array if none.
         */
        function loadRestrictionMessages() {
            const messagesJson = localStorage.getItem('stakingHubRestrictionMessages');
            return messagesJson ? JSON.parse(messagesJson) : [];
        }

        /**
         * Saves start screen settings to local storage.
         */
        function saveStartScreenSettings() {
            localStorage.setItem('stakingHubStartScreenSettings', JSON.stringify(startScreenSettings));
        }

        /**
         * Loads start screen settings from local storage.
         */
        function loadStartScreenSettings() {
            const storedSettings = localStorage.getItem('stakingHubStartScreenSettings');
            if (storedSettings) {
                // Merge loaded settings with default to ensure new properties are handled
                startScreenSettings = { ...startScreenSettings, ...JSON.parse(storedSettings) };
            }
        }


        /**
         * Hides all main sections.
         */
        function hideAllSections() {
            startScreen.classList.add('hidden');
            signUpFormSection.classList.add('hidden');
            signInFormSection.classList.add('hidden');
            userDashboardSection.classList.add('hidden');
            adminDashboardSection.classList.add('hidden');
        }

        /**
         * Shows a specific section.
         * @param {HTMLElement} section The section to show.
         */
        function showSection(section) {
            hideAllSections();
            section.classList.remove('hidden');
        }

        /**
         * Updates header buttons based on login status.
         */
        function updateHeaderButtons() {
            if (currentUser || isAdmin) {
                showSignInBtn.classList.add('hidden');
                showSignUpBtn.classList.add('hidden');
                signOutBtn.classList.remove('hidden');
            } else {
                showSignInBtn.classList.remove('hidden');
                showSignUpBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');
            }
        }

        // --- User Authentication Functions ---

        /**
         * Handles user sign-up.
         * @param {Event} e The submit event.
         */
        function handleSignUp(e) {
            e.preventDefault();
            const email = signUpEmail.value.trim();
            const password = signUpPassword.value;
            const referralCode = document.getElementById('referralCode').value.trim();

            if (!email || !password || !referralCode) {
                showModal('Please fill in all fields.');
                return;
            }

            if (password.length < 6) {
                showModal('Password must be at least 6 characters long.');
                return;
            }

            let users = loadUsers();
            if (users.some(u => u.email === email)) {
                showModal('This email is already registered.');
                return;
            }

            // Validate referral code (must exist in system or be admin's)
            const referrer = users.find(u => u.userReferralCode === referralCode);
            const isAdminReferral = referralCode === ADMIN_REFERRAL_CODE;

            if (!referrer && !isAdminReferral) {
                showModal('Invalid referral code. Please check and try again.');
                return;
            }

            const newUser = {
                id: generateUniqueId(),
                email: email,
                password: password, // In a real app, hash this password!
                userReferralCode: generateUniqueId().substring(0, 8).toUpperCase(), // Unique referral code for new user
                referredBy: referralCode, // The code used to sign up
                balance: 0,
                level: 0,
                directReferrals: 0,
                lastWithdrawalMonth: null,
                lastWithdrawalAmount: 0,
                transactions: [],
                referredUsers: [], // Users who signed up using this user's code and made first deposit
                lastInterestCreditTime: Date.now(), // Timestamp for daily interest calculation
                withdrawalCompletionTime: null, // Timestamp for withdrawal completion
                primaryWithdrawalAddress: '', // Stores the single primary withdrawal address
                firstDepositTime: null // New: Timestamp of the first approved deposit
            };

            users.push(newUser);
            saveUsers(users);
            showModal('Account created successfully! Please sign in.');
            showSection(signInFormSection);
            signUpForm.reset();
        }

        /**
         * Handles user sign-in.
         * @param {Event} e The submit event.
         */
        function handleSignIn(e) {
            e.preventDefault();
            const email = signInEmail.value.trim();
            const password = signInPassword.value;

            // Check for admin login first
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                isAdmin = true;
                currentUser = null;
                showModal('Admin signed in successfully!');
                renderAdminDashboard();
                showSection(adminDashboardSection);
                updateHeaderButtons();
                signInForm.reset();
                return; // Exit function after admin login
            }

            // If not admin, proceed with regular user login
            let users = loadUsers();
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                isAdmin = false;
                showModal('Signed in successfully!');
                renderUserDashboard();
                showSection(userDashboardSection);
                updateHeaderButtons();
                signInForm.reset();
            } else {
                showModal('Invalid email or password.');
            }
        }

        /**
         * Handles user sign-out.
         */
        function handleSignOut() {
            currentUser = null;
            isAdmin = false;
            clearInterval(dailyInterestInterval); // Stop daily interest timer
            clearInterval(withdrawalCompletionInterval); // Stop withdrawal timer
            showModal('Signed out successfully!');
            showSection(startScreen);
            updateHeaderButtons();
        }

        // --- Dashboard Rendering and Logic ---

        /**
         * Calculates user level based on balance and direct referrals.
         * @param {Object} user The user object.
         * @returns {number} The calculated level.
         */
        function calculateUserLevel(user) {
            let level = 0;
            // Get all level numbers and sort them in descending order
            const sortedLevels = Object.keys(LEVELS).map(Number).sort((a, b) => b - a);

            for (const lvl of sortedLevels) {
                if (lvl === 0) continue; // Level 0 is base, not earned by criteria
                const levelConfig = LEVELS[lvl];
                if (user.balance >= levelConfig.minBalance && user.directReferrals >= levelConfig.directReferrals) {
                    level = lvl;
                    break;
                }
            }
            return level;
        }

        /**
         * Renders the user dashboard with current user data.
         */
        function renderUserDashboard() {
            if (!currentUser) return;

            currentUser.level = calculateUserLevel(currentUser);
            updateUserData(currentUser); // Save updated level

            dashboardUserIdElem.textContent = currentUser.id;
            totalUsdtBalanceElem.textContent = `${currentUser.balance.toFixed(2)} USDT`;

            // Update Level Badge
            currentLevelBadgeElem.textContent = currentUser.level;
            currentLevelBadgeElem.className = `level-badge level-${currentUser.level}`;

            // Update Level Details
            const currentLevelConfig = LEVELS[currentUser.level];
            interestRateElem.textContent = `${(currentLevelConfig.interest * 100).toFixed(1)}%`;
            minBalanceElem.textContent = `${currentLevelConfig.minBalance} USDT`;
            monthlyWithdrawalLimitElem.textContent = `${currentLevelConfig.withdrawalLimit} USDT`;

            // Set primary withdrawal address in the withdrawal input field
            withdrawAddressInput.value = currentUser.primaryWithdrawalAddress || '';
            newPrimaryWithdrawalAddressInput.value = currentUser.primaryWithdrawalAddress || ''; // Also update the change panel input

            // Display current global deposit address
            rechargeAddressElem.textContent = RECHARGE_ADDRESS;

            // Apply panel visibility settings
            document.getElementById('userOverviewPanel').classList.toggle('hidden', !dashboardPanelVisibility.userOverviewPanel);
            document.getElementById('userLevelPanel').classList.toggle('hidden', !dashboardPanelVisibility.userLevelPanel);
            document.getElementById('dailyInterestPanel').classList.toggle('hidden', !dashboardPanelVisibility.dailyInterestPanel);
            document.getElementById('rechargePanel').classList.toggle('hidden', !dashboardPanelVisibility.rechargePanel);
            document.getElementById('withdrawPanel').classList.toggle('hidden', !dashboardPanelVisibility.withdrawPanel);
            document.getElementById('userReferralPanel').classList.toggle('hidden', !dashboardPanelVisibility.userReferralPanel);
            document.getElementById('changeWithdrawalAddressPanel').classList.toggle('hidden', !dashboardPanelVisibility.changeWithdrawalAddressPanel);
            document.getElementById('transactionHistoryPanel').classList.toggle('hidden', !dashboardPanelVisibility.transactionHistoryPanel);
            document.getElementById('levelDetailsPanel').classList.toggle('hidden', !dashboardPanelVisibility.levelDetailsPanel);
            // userAdminContentPanel visibility is handled by renderUserAdminContent itself

            renderReferralPanel(); // Render referral panel
            renderReferredUsers();
            renderTransactionHistory();
            renderLevelDetails(); // Render the new level details panel
            renderUserAdminContent(); // Render admin managed content for user
            renderUserRestrictionMessages(); // Render admin managed restriction messages for user
            startDailyInterestTimer(); // Start daily interest timer (with level check inside)
            startWithdrawalCompletionTimer();
        }

        /**
         * Renders the new Referral Panel content.
         */
        function renderReferralPanel() {
            if (!currentUser) return;

            userReferralCodeElem.textContent = currentUser.userReferralCode;
            currentDirectReferralsElem.textContent = currentUser.directReferrals;

            let referralsNeededText = 'Max Level Achieved!';
            // Find the highest existing level number
            const maxLevel = Math.max(...Object.keys(LEVELS).map(Number));

            if (currentUser.level < maxLevel) {
                const nextLevel = currentUser.level + 1;
                // Find the next available level config. If nextLevel doesn't exist, try higher ones.
                let nextLevelConfig = null;
                for (let i = nextLevel; i <= maxLevel; i++) {
                    if (LEVELS[i]) {
                        nextLevelConfig = LEVELS[i];
                        break;
                    }
                }

                if (nextLevelConfig) {
                    const needed = nextLevelConfig.directReferrals - currentUser.directReferrals;
                    referralsNeededText = needed > 0 ? needed : '0 (Next Level Unlocked)';
                } else {
                    referralsNeededText = 'N/A (No higher levels defined)';
                }
            }
            referralsToNextLevelElem.textContent = referralsNeededText;
        }


        /**
         * Renders the list of referred users.
         */
        function renderReferredUsers() {
            referredUsersListElem.innerHTML = '';
            if (currentUser.referredUsers && currentUser.referredUsers.length > 0) {
                const allUsers = loadUsers(); // Get all users to display email
                currentUser.referredUsers.forEach(referredId => {
                    const referredUser = allUsers.find(u => u.id === referredId);
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center space-x-2 text-gray-100'; /* Ensure text is white */
                    listItem.innerHTML = `<i class="fas fa-user-check text-green-400"></i> <span>${referredId} (${referredUser ? referredUser.email : 'Unknown'})</span>`;
                    referredUsersListElem.appendChild(listItem);
                });
            } else {
                referredUsersListElem.innerHTML = '<li class="text-gray-500">No referrals yet. Share your code!</li>';
            }
        }

        /**
         * Sets the primary withdrawal address.
         */
        function setPrimaryWithdrawalAddress() {
            const addressToSet = newPrimaryWithdrawalAddressInput.value.trim();

            if (!addressToSet) {
                showModal('Please enter a BEP-20 address.');
                return;
            }
            if (!addressToSet.startsWith('0x') || addressToSet.length !== 42) {
                showModal('Please enter a valid BEP-20 address (starts with 0x and is 42 characters long).');
                return;
            }

            currentUser.primaryWithdrawalAddress = addressToSet;
            // Ensure the withdrawalAddresses array (if used elsewhere for historical reasons) only holds this one
            // This array is kept for compatibility with admin panel display, but functionally only primaryWithdrawalAddress is used.
            currentUser.withdrawalAddresses = [addressToSet];
            updateUserData(currentUser);
            // Update the main withdrawal input field immediately
            withdrawAddressInput.value = addressToSet;
            // newPrimaryWithdrawalAddressInput.value = ''; // Keep the value in the input for easy editing
            showModal('Primary withdrawal address updated successfully!');
        }

        /**
         * Renders the transaction history.
         */
        function renderTransactionHistory() {
            transactionHistoryElem.innerHTML = '';
            if (currentUser.transactions && currentUser.transactions.length > 0) {
                // Sort transactions by timestamp descending
                const sortedTransactions = [...currentUser.transactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                sortedTransactions.forEach(tx => {
                    const txDiv = document.createElement('div');
                    let statusColor = 'text-yellow-400';
                    if (tx.status === 'approved' || tx.status === 'credited' || tx.status === 'completed') { // Added 'completed' for admin adjustments
                        statusColor = 'text-green-400';
                    } else if (tx.status === 'declined') {
                        statusColor = 'text-red-400';
                    }

                    let bgColor = 'bg-blue-800 bg-opacity-30';
                    let amountDisplay = '';

                    switch (tx.type) {
                        case 'deposit':
                            bgColor = 'bg-green-800 bg-opacity-30';
                            amountDisplay = `<p class="text-base text-gray-100">Amount: <span class="text-green-300">${tx.amount.toFixed(2)} USDT</span></p>`;
                            break;
                        case 'withdrawal':
                            bgColor = 'bg-red-800 bg-opacity-30';
                            amountDisplay = `<p class="text-base text-gray-100">Amount: <span class="text-red-300">${tx.amount.toFixed(2)} USDT</span></p>`;
                            break;
                        case 'interest_credit':
                            bgColor = 'bg-purple-800 bg-opacity-30';
                            amountDisplay = `<p class="text-base text-gray-100">Earned: <span class="text-purple-300">${tx.amount.toFixed(4)} USDT</span></p>`;
                            break;
                        case 'referral_bonus':
                            bgColor = 'bg-yellow-800 bg-opacity-30';
                            amountDisplay = `<p class="text-base text-gray-100">Bonus: <span class="text-yellow-300">${tx.amount.toFixed(2)} USDT</span></p>`;
                            break;
                        case 'admin_adjusted': // New type for admin adjustments
                            bgColor = 'bg-indigo-800 bg-opacity-30';
                            amountDisplay = `<p class="text-base text-gray-100">Adjustment: <span class="text-indigo-300">${tx.amount.toFixed(2)} USDT</span></p>`;
                            break;
                        default:
                            break;
                    }

                    txDiv.className = `p-3 rounded-md ${bgColor}`;
                    txDiv.innerHTML = `
                        <p class="font-semibold text-white capitalize">${tx.type.replace('_', ' ')}</p>
                        <p class="text-sm text-gray-100">${new Date(tx.timestamp).toLocaleString()}</p>
                        ${amountDisplay}
                        <p class="text-base text-gray-100">Status: <span class="font-medium ${statusColor}">${tx.status.toUpperCase()}</span></p>
                        ${tx.type === 'withdrawal' && tx.status === 'approved' && tx.completionTime ? `<p class="text-sm text-blue-300">Expected Completion: ${new Date(tx.completionTime).toLocaleString()}</p>` : ''}
                    `;
                    transactionHistoryElem.appendChild(txDiv);
                });
            } else {
                transactionHistoryElem.innerHTML = '<p class="text-gray-500">No transactions yet.</p>';
            }
        }

        /**
         * Renders the details for all staking levels in the new panel.
         */
        function renderLevelDetails() {
            levelDetailsListElem.innerHTML = ''; // Clear previous content

            // Get all level numbers and sort them in ascending order for display
            const sortedLevels = Object.keys(LEVELS).map(Number).sort((a, b) => a - b);

            sortedLevels.forEach(level => {
                const config = LEVELS[level];

                const levelDiv = document.createElement('div');
                levelDiv.className = 'p-3 rounded-md bg-gray-800 bg-opacity-40 border border-gray-700';
                levelDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <p class="font-bold text-lg text-white">Level ${level}</p>
                        <div class="level-badge level-${level}">${level}</div>
                    </div>
                    <p class="text-base text-gray-100">Daily Interest: <span class="text-green-300">${(config.interest * 100).toFixed(1)}%</span></p>
                    <p class="text-base text-gray-100">Min Balance: <span class="text-yellow-300">${config.minBalance} USDT</span></p>
                    <p class="text-base text-gray-100">Direct Referrals: <span class="text-blue-300">${config.directReferrals}</span></p>
                    <p class="text-base text-gray-100">Monthly Withdrawal Limit: <span class="text-purple-300">${config.withdrawalLimit} USDT</span></p>
                `;
                levelDetailsListElem.appendChild(levelDiv);
            });
        }

        /**
         * Renders admin managed content for the current user.
         */
        function renderUserAdminContent() {
            userAdminContentList.innerHTML = ''; // Clear previous content
            const relevantContent = adminManagedContent.filter(content =>
                content.isActive && (content.global || content.targetUserId === currentUser.id)
            );

            if (relevantContent.length === 0) {
                userAdminContentPanel.classList.add('hidden');
                userAdminContentList.innerHTML = '<p class="text-gray-500">No announcements or tasks from admin.</p>';
            } else {
                userAdminContentPanel.classList.remove('hidden');
                relevantContent.forEach(content => {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'p-3 rounded-md bg-gray-700 bg-opacity-50 border border-gray-600';
                    contentDiv.innerHTML = `
                        <h4 class="font-bold text-lg text-white">${content.title} <span class="text-sm text-blue-300">(${content.type})</span></h4>
                        <p class="text-base text-gray-100 mt-1">${content.body}</p>
                    `;
                    userAdminContentList.appendChild(contentDiv);
                });
            }
        }

        /**
         * Renders active restriction messages on the user dashboard.
         */
        function renderUserRestrictionMessages() {
            depositRestrictionMessagesElem.innerHTML = '';
            withdrawalRestrictionMessagesElem.innerHTML = '';

            const activeDepositMessages = adminRestrictionMessages.filter(msg => msg.isActive && msg.type === 'deposit');
            const activeWithdrawalMessages = adminRestrictionMessages.filter(msg => msg.isActive && msg.type === 'withdrawal');

            activeDepositMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'bg-red-900/30 border-l-4 border-red-500 p-3 rounded-md text-sm text-gray-100 mb-2';
                msgDiv.innerHTML = `<i class="fas fa-exclamation-triangle text-red-400 mr-2"></i> ${msg.message}`;
                depositRestrictionMessagesElem.appendChild(msgDiv);
            });

            activeWithdrawalMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'bg-red-900/30 border-l-4 border-red-500 p-3 rounded-md text-sm text-gray-100 mb-2';
                msgDiv.innerHTML = `<i class="fas fa-exclamation-triangle text-red-400 mr-2"></i> ${msg.message}`;
                withdrawalRestrictionMessagesElem.appendChild(msgDiv);
            });
        }


        /**
         * Starts the 24-hour daily interest calculation timer.
         */
        function startDailyInterestTimer() {
            clearInterval(dailyInterestInterval); // Clear any existing interval

            if (currentUser.level === 0) {
                dailyInterestMessageElem.textContent = 'Reach Level 1 to earn daily interest.';
                dailyInterestTimerElem.textContent = 'N/A';
                return;
            } else {
                dailyInterestMessageElem.textContent = 'Next credit in:';
            }

            const updateTimer = () => {
                const now = Date.now();
                // Ensure lastInterestCreditTime is set for new users or if it's somehow missing
                if (!currentUser.lastInterestCreditTime || currentUser.lastInterestCreditTime === 0) {
                    currentUser.lastInterestCreditTime = now;
                    updateUserData(currentUser);
                }

                const timeElapsed = now - currentUser.lastInterestCreditTime;

                if (timeElapsed >= ONE_DAY_MS) {
                    // It's time to credit interest, and user is level 1 or higher
                    const dailyInterest = currentUser.balance * LEVELS[currentUser.level].interest;
                    currentUser.balance += dailyInterest; // Directly add to total balance
                    currentUser.lastInterestCreditTime = now; // Update last credit time for next cycle

                    // Add interest credit to transaction history
                    currentUser.transactions.push({
                        id: generateUniqueId(),
                        userId: currentUser.id,
                        type: 'interest_credit',
                        amount: dailyInterest,
                        status: 'credited',
                        timestamp: now
                    });

                    updateUserData(currentUser);
                    renderUserDashboard(); // Re-render to show updated balance and history
                    showModal(`Daily interest credited! You earned ${dailyInterest.toFixed(4)} USDT.`);
                }

                const timeLeft = ONE_DAY_MS - (timeElapsed % ONE_DAY_MS);
                const hours = Math.floor(timeLeft / ONE_HOUR_MS);
                const minutes = Math.floor((timeLeft % ONE_HOUR_MS) / ONE_MINUTE_MS);
                const seconds = Math.floor((timeLeft % ONE_MINUTE_MS) / ONE_SECOND_MS);

                dailyInterestTimerElem.textContent =
                    `${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;
            };

            dailyInterestInterval = setInterval(updateTimer, ONE_SECOND_MS);
            updateTimer(); // Call immediately to show initial time
        }

        /**
         * Starts the withdrawal completion timer.
         */
        function startWithdrawalCompletionTimer() {
            clearInterval(withdrawalCompletionInterval); // Clear any existing interval

            if (!currentUser.withdrawalCompletionTime) {
                withdrawalTimerDisplayElem.classList.add('hidden');
                return;
            }

            withdrawalTimerDisplayElem.classList.remove('hidden');

            const updateTimer = () => {
                const now = Date.now();
                const completionTime = currentUser.withdrawalCompletionTime;
                const timeLeft = completionTime - now;

                if (timeLeft <= 0) {
                    withdrawalTimerElem.textContent = 'Completed!';
                    clearInterval(withdrawalCompletionInterval);
                    currentUser.withdrawalCompletionTime = null; // Clear completion time
                    updateUserData(currentUser);
                    renderUserDashboard();
                    return;
                }

                const days = Math.floor(timeLeft / ONE_DAY_MS);
                const hours = Math.floor((timeLeft % ONE_DAY_MS) / ONE_HOUR_MS);
                const minutes = Math.floor((timeLeft % ONE_HOUR_MS) / ONE_MINUTE_MS);
                const seconds = Math.floor((timeLeft % ONE_MINUTE_MS) / ONE_SECOND_MS);

                withdrawalTimerElem.textContent =
                    `${String(days).padStart(2, '0')} Days ${String(hours).padStart(2, '0')} Hrs ${String(minutes).padStart(2, '0')} Mins ${String(seconds).padStart(2, '0')} Secs`;
            };

            withdrawalCompletionInterval = setInterval(updateTimer, ONE_SECOND_MS);
            updateTimer();
        }

        /**
         * Processes the actual recharge submission after confirmation.
         * @param {number} amount The recharge amount.
         */
        function processRechargeSubmission(amount) {
            // Create a pending transaction for the user's history
            const newTransactionForUser = {
                id: generateUniqueId(),
                userId: currentUser.id,
                type: 'deposit',
                amount: amount,
                status: 'pending',
                timestamp: Date.now(),
                walletAddress: RECHARGE_ADDRESS // Use the current global RECHARGE_ADDRESS
            };
            currentUser.transactions.push(newTransactionForUser);
            updateUserData(currentUser); // Save user with new pending transaction

            // Create a separate transaction for admin approval queue
            let transactions = loadTransactions();
            const newTransactionForAdminQueue = {
                id: newTransactionForUser.id, // Use the same ID to link
                userId: currentUser.id,
                email: currentUser.email,
                type: 'deposit',
                amount: amount,
                status: 'pending',
                timestamp: Date.now(),
                walletAddress: RECHARGE_ADDRESS // The address user sent to
            };
            transactions.push(newTransactionForAdminQueue);
            saveTransactions(transactions);

            // This is the message that confirms the request has been submitted for admin approval.
            // Increased timeout to ensure the previous modal is fully dismissed before this one appears.
            setTimeout(() => {
                showModal('Recharge request submitted successfully! Awaiting admin approval.');
                rechargeAmountInput.value = '';
                renderUserDashboard(); // Update transaction history
            }, 500); // Increased to 500ms delay
        }

        /**
         * Handles recharge request submission.
         * @param {Event} e The submit event.
         */
        function handleSubmitRecharge(e) {
            e.preventDefault();
            const amount = parseFloat(rechargeAmountInput.value);

            if (isNaN(amount) || amount <= 0) {
                showModal('Please enter a valid recharge amount.');
                return;
            }

            // --- First Restriction: Check for withdrawal address ---
            if (!currentUser.primaryWithdrawalAddress || currentUser.primaryWithdrawalAddress.trim() === '') {
                showModal('Please set your primary withdrawal address in the "Change Withdrawal BEP-20 Address" panel before submitting a recharge request.');
                return;
            }

            // --- Second Warning: Confirmation (with Cancel option) ---
            const confirmationMessage = "Make Sure you added Valid and Same withdrawal addresses from which You deposit Usdt on above address. Different address Cause permanent loss of funds.";
            showModal(
                confirmationMessage,
                () => { // onConfirm callback
                    processRechargeSubmission(amount);
                },
                () => { // onCancel callback
                    showModal('Recharge request cancelled.');
                },
                0, // No auto-close delay
                'OK to Proceed',
                'Cancel'
            );
        }

        /**
         * Handles withdrawal request submission.
         * @param {Event} e The submit event.
         */
        function handleSubmitWithdrawal(e) {
            e.preventDefault();
            const amount = parseFloat(withdrawAmountInput.value);
            const walletAddress = withdrawAddressInput.value.trim();

            if (isNaN(amount) || amount <= 0) { // Changed to amount <= 0, min amount is checked later
                showModal('Please enter a valid withdrawal amount.');
                return;
            }
            if (amount < MIN_WITHDRAWAL_AMOUNT) {
                showModal(`Minimum withdrawal amount is ${MIN_WITHDRAWAL_AMOUNT} USDT.`);
                return;
            }
            if (!walletAddress) {
                showModal('Please ensure your primary BEP-20 wallet address is set in the "Change Withdrawal BEP-20 Address" panel.');
                return;
            }
            if (amount > currentUser.balance) {
                showModal('Insufficient balance for this withdrawal.');
                return;
            }

            // --- Withdrawal Restriction: X days from first deposit (now configurable) ---
            if (WITHDRAWAL_LOCK_PERIOD_DAYS > 0) { // Only apply restriction if days > 0
                if (!currentUser.firstDepositTime) {
                    showModal(`Please wait for ${WITHDRAWAL_LOCK_PERIOD_DAYS} days to initiate withdrawal request.`);
                    return;
                }
                const withdrawalLockPeriodMs = WITHDRAWAL_LOCK_PERIOD_DAYS * ONE_DAY_MS; // Use the current configurable value
                const timeSinceFirstDeposit = Date.now() - currentUser.firstDepositTime;
                if (timeSinceFirstDeposit < withdrawalLockPeriodMs) {
                    const remainingTimeMs = withdrawalLockPeriodMs - timeSinceFirstDeposit;
                    const days = Math.floor(remainingTimeMs / ONE_DAY_MS);
                    const hours = Math.floor((remainingTimeMs % ONE_DAY_MS) / ONE_HOUR_MS);
                    const minutes = Math.floor((remainingTimeMs % ONE_HOUR_MS) / ONE_MINUTE_MS);
                    const seconds = Math.floor((remainingTimeMs % ONE_MINUTE_MS) / ONE_SECOND_MS);

                    const timerMessage = `Withdrawal is restricted for ${WITHDRAWAL_LOCK_PERIOD_DAYS} days from your first deposit. Remaining: ${String(days).padStart(2, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s.`;

                    showModal(
                        timerMessage,
                        null, // No direct action on OK for this message, just dismiss
                        null, // No cancel action needed
                        10000, // Auto-close after 10 seconds
                        'OK', // OK button text
                        'Cancel', // Cancel button text (though it's hidden if onCancel is null)
                        true // Show timer on the modal
                    );
                    return;
                }
            }
            // --- End Withdrawal Restriction ---


            // Check monthly withdrawal limit
            const currentLevelConfig = LEVELS[currentUser.level];
            const withdrawalLimit = currentLevelConfig.withdrawalLimit;

            const currentMonth = new Date().toLocaleString('en-US', { month: 'short', year: 'numeric' });

            // Calculate current month's withdrawals
            const currentMonthWithdrawals = currentUser.transactions
                .filter(tx => tx.type === 'withdrawal' && tx.status === 'approved' && new Date(tx.timestamp).toLocaleString('en-US', { month: 'short', year: 'numeric' }) === currentMonth)
                .reduce((sum, tx) => sum + tx.amount, 0);

            if ((currentMonthWithdrawals + amount) > withdrawalLimit) {
                showModal(`You have exceeded your monthly withdrawal limit of ${withdrawalLimit} USDT for ${currentMonth}.`);
                return;
            }

            // Deduct from balance immediately (or after admin approval, depending on desired flow)
            // For now, let's deduct upon request, and refund if declined.
            currentUser.balance -= amount;

            // Create a pending transaction for the user's history
            const newTransactionForUser = {
                id: generateUniqueId(),
                userId: currentUser.id,
                type: 'withdrawal',
                amount: amount,
                status: 'pending',
                timestamp: Date.now(),
                walletAddress: walletAddress
            };
            currentUser.transactions.push(newTransactionForUser);
            updateUserData(currentUser); // Save user with new pending transaction and updated balance

            // Create a separate transaction for admin approval queue
            let transactions = loadTransactions();
            const newTransactionForAdminQueue = {
                id: newTransactionForUser.id, // Use the same ID to link
                userId: currentUser.id,
                email: currentUser.email,
                type: 'withdrawal',
                amount: amount,
                status: 'pending',
                timestamp: Date.now(),
                walletAddress: walletAddress
            };
            transactions.push(newTransactionForAdminQueue);
            saveTransactions(transactions);


            showModal('Withdrawal request submitted successfully! Awaiting admin approval.');
            withdrawAmountInput.value = '';
            // withdrawAddressInput.value = ''; // Keep primary address in place
            renderUserDashboard(); // Update balance and transaction history
        }

        // --- Admin Dashboard Rendering and Logic ---

        /**
         * Renders the admin dashboard with pending requests.
         */
        function renderAdminDashboard() {
            if (!isAdmin) return;

            const transactions = loadTransactions();
            const users = loadUsers(); // Needed to find user details for requests
            systemFunds = loadSystemFunds(); // Load system funds

            // Admin Overview
            adminReferralCodeDisplay.textContent = ADMIN_REFERRAL_CODE;
            const adminReferralsCount = users.filter(u => u.referredBy === ADMIN_REFERRAL_CODE).length;
            // totalAdminReferralsElem.textContent = adminReferralsCount; // This element doesn't exist in the HTML, should be removed or added.
            adminSystemFundsDisplay.textContent = `${systemFunds.toFixed(2)} USDT`; // Update admin balance display

            // Calculate Total USDT in Circulation (System Funds + All User Balances)
            // totalUsdtInCirculationElem.textContent = `${(totalUserBalances + systemFunds).toFixed(2)} USDT`; // This element doesn't exist in the HTML, should be removed or added.

            // Calculate Total Referral Bonuses Paid
            const totalReferralBonuses = transactions.filter(tx => tx.type === 'referral_bonus' && tx.status === 'credited').reduce((sum, tx) => sum + tx.amount, 0);
            totalReferralBonusesPaidElem.textContent = `${totalReferralBonuses.toFixed(2)} USDT`;

            // Update website name input
            adminWebsiteNameInput.value = currentWebsiteName;


            depositRequestsElem.innerHTML = '';
            withdrawalRequestsElem.innerHTML = '';
            allUsersListElem.innerHTML = ''; // Clear previous list

            const pendingDeposits = transactions.filter(tx => tx.type === 'deposit' && tx.status === 'pending');
            const pendingWithdrawals = transactions.filter(tx => tx.type === 'withdrawal' && tx.status === 'pending');

            if (pendingDeposits.length === 0) {
                depositRequestsElem.innerHTML = '<p class="text-gray-500">No pending deposit requests.</p>';
            } else {
                pendingDeposits.forEach(tx => {
                    const user = users.find(u => u.id === tx.userId);
                    const txDiv = document.createElement('div');
                    txDiv.className = 'card gradient-blue-purple p-4 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0';
                    txDiv.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">Deposit Request from <span class="text-blue-300">${user ? user.email : 'Unknown User'}</span></p>
                            <p class="text-base text-gray-100">User ID: <span class="font-mono text-sm break-all text-blue-200">${tx.userId}</span></p>
                            <p class="text-lg text-green-400 font-bold">${tx.amount.toFixed(2)} USDT</p>
                            <p class="text-sm text-gray-100">${new Date(tx.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveTransaction('${tx.id}')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Approve</button>
                            <button onclick="declineTransaction('${tx.id}')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Decline</button>
                        </div>
                    `;
                    depositRequestsElem.appendChild(txDiv);
                });
            }

            if (pendingWithdrawals.length === 0) {
                withdrawalRequestsElem.innerHTML = '<p class="text-gray-500">No pending withdrawal requests.</p>';
            } else {
                pendingWithdrawals.forEach(tx => {
                    const user = users.find(u => u.id === tx.userId);
                    const txDiv = document.createElement('div');
                    txDiv.className = 'card gradient-green-cyan p-4 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0';
                    txDiv.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">Withdrawal Request from <span class="text-blue-300">${user ? user.email : 'Unknown User'}</span></p>
                            <p class="text-base text-gray-100">User ID: <span class="font-mono text-sm break-all text-blue-200">${tx.userId}</span></p>
                            <p class="text-lg text-red-400 font-bold">${tx.amount.toFixed(2)} USDT</p>
                            <p class="text-base text-gray-100">Wallet: <span class="font-mono text-sm break-all text-blue-300">${tx.walletAddress}</span></p>
                            <p class="text-sm text-gray-100">${new Date(tx.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveTransaction('${tx.id}')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Approve</button>
                            <button onclick="declineTransaction('${tx.id}')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Decline</button>
                        </div>
                    `;
                    withdrawalRequestsElem.appendChild(txDiv);
                });
            }

            // Update Global Deposit Address display
            currentGlobalDepositAddressElem.textContent = RECHARGE_ADDRESS;
            newGlobalDepositAddressInput.value = RECHARGE_ADDRESS; // Pre-fill the input with current address

            // Update Withdrawal Restriction display
            currentWithdrawalRestrictionDaysElem.textContent = WITHDRAWAL_LOCK_PERIOD_DAYS;
            newWithdrawalRestrictionDaysInput.value = WITHDRAWAL_LOCK_PERIOD_DAYS;


            // Populate All Users List (for quick overview)
            if (users.length === 0) {
                allUsersListElem.innerHTML = '<p class="text-gray-500">No users registered.</p>';
            } else {
                allUsersListElem.innerHTML = ''; // Clear previous content
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'bg-gray-700 p-3 rounded-md flex items-center justify-between';
                    userDiv.innerHTML = `
                        <p class="text-base text-gray-100 break-all">${user.email} (<span class="font-mono text-xs text-gray-300">${user.id}</span>)</p>
                        <button onclick="searchUserById('${user.id}')" class="ml-2 px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600">Select</button>
                    `;
                    allUsersListElem.appendChild(userDiv);
                });
            }

            // Reset selected user panel
            selectedAdminUser = null;
            selectedUserWalletPanel.classList.add('hidden');
            adminUpdateUserEmailInput.value = ''; // Clear new email input
            adminUpdateWithdrawalAddressInput.value = '';
            adminAdjustBalanceAmountInput.value = '';
            adminSetUserLevelSelect.innerHTML = ''; // Clear level dropdown

            renderAdminLevelManagement(); // Render the admin level management panel
            renderAdminContentManagement(); // Render admin content management
            renderDashboardPanelVisibilityControls(); // Render dashboard panel visibility controls
            renderThemeSettings(); // Render theme settings
            renderAdminReferredUsers(); // Render admin referred users list
            renderAdminRestrictionMessages(); // Render admin restriction messages
            renderAdminStartScreenCustomization(); // Render start screen customization
        }

        /**
         * Renders the admin level management panel.
         */
        function renderAdminLevelManagement() {
            levelConfigList.innerHTML = ''; // Clear previous content

            // Get all level numbers and sort them in ascending order for display
            const sortedLevels = Object.keys(LEVELS).map(Number).sort((a, b) => a - b);

            sortedLevels.forEach(level => {
                const config = LEVELS[level];

                const levelDiv = document.createElement('div');
                levelDiv.className = 'p-4 rounded-md bg-gray-800 bg-opacity-40 border border-gray-700';
                levelDiv.innerHTML = `
                    <h4 class="font-bold text-lg text-white mb-2">Level ${level}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-100 text-sm font-bold mb-1">Interest Rate (%):</label>
                            <input type="number" id="level-${level}-interest" class="input-field w-full py-2 px-3 text-base" value="${(config.interest * 100).toFixed(3)}" step="0.001">
                        </div>
                        <div>
                            <label class="block text-gray-100 text-sm font-bold mb-1">Min Balance (USDT):</label>
                            <input type="number" id="level-${level}-minBalance" class="input-field w-full py-2 px-3 text-base" value="${config.minBalance}" min="0" step="1">
                        </div>
                        <div>
                            <label class="block text-gray-100 text-sm font-bold mb-1">Direct Referrals:</label>
                            <input type="number" id="level-${level}-referrals" class="input-field w-full py-2 px-3 text-base" value="${config.directReferrals}" min="0" step="1">
                        </div>
                        <div>
                            <label class="block text-gray-100 text-sm font-bold mb-1">Monthly Withdrawal Limit (USDT):</label>
                            <input type="number" id="level-${level}-withdrawalLimit" class="input-field w-full py-2 px-3 text-base" value="${config.withdrawalLimit}" min="0" step="1">
                        </div>
                    </div>
                    <button onclick="updateLevelConfig(${level})" class="btn btn-primary w-full py-2 rounded-lg font-bold text-lg mt-3">Save Level ${level} Changes</button>
                `;
                levelConfigList.appendChild(levelDiv);
            });
        }

        /**
         * Updates a specific level's configuration.
         * @param {number} level The level number to update.
         */
        function updateLevelConfig(level) {
            const interestInput = document.getElementById(`level-${level}-interest`);
            const minBalanceInput = document.getElementById(`level-${level}-minBalance`);
            const referralsInput = document.getElementById(`level-${level}-referrals`);
            const withdrawalLimitInput = document.getElementById(`level-${level}-withdrawalLimit`);

            const newInterest = parseFloat(interestInput.value) / 100; // Convert back to decimal
            const newMinBalance = parseInt(minBalanceInput.value);
            const newReferrals = parseInt(referralsInput.value);
            const newWithdrawalLimit = parseInt(withdrawalLimitInput.value);

            if (isNaN(newInterest) || isNaN(newMinBalance) || isNaN(newReferrals) || isNaN(newWithdrawalLimit) || newInterest < 0 || newMinBalance < 0 || newReferrals < 0 || newWithdrawalLimit < 0) {
                showModal('Please enter valid positive numbers for all fields.');
                return;
            }

            LEVELS[level] = {
                interest: newInterest,
                minBalance: newMinBalance,
                directReferrals: newReferrals,
                withdrawalLimit: newWithdrawalLimit
            };
            saveLevelsConfig();
            renderAdminLevelManagement(); // Re-render to show updated values
            if (currentUser) { // Only re-render user dashboard if a user is logged in
                renderUserDashboard(); // Re-render user dashboard to reflect potential level changes
            }
            showModal(`Level ${level} configuration updated successfully!`);
        }

        /**
         * Adds a new staking level.
         */
        function addLevelConfig() {
            const level = parseInt(newLevelNumberInput.value);
            const interest = parseFloat(newLevelInterestInput.value) / 100;
            const minBalance = parseInt(newLevelMinBalanceInput.value);
            const referrals = parseInt(newLevelReferralsInput.value);
            const withdrawalLimit = parseInt(newLevelWithdrawalLimitInput.value);

            if (isNaN(level) || isNaN(interest) || isNaN(minBalance) || isNaN(referrals) || isNaN(withdrawalLimit) || level < 0 || interest < 0 || minBalance < 0 || referrals < 0 || withdrawalLimit < 0) {
                showModal('Please enter valid positive numbers for all new level fields.');
                return;
            }
            if (LEVELS[level]) {
                showModal(`Level ${level} already exists. Please choose a different level number or modify the existing one.`);
                return;
            }

            LEVELS[level] = {
                interest: interest,
                minBalance: minBalance,
                directReferrals: referrals,
                withdrawalLimit: withdrawalLimit
            };
            saveLevelsConfig();
            renderAdminLevelManagement(); // Re-render to show the new level
            if (currentUser) { // Only re-render user dashboard if a user is logged in
                renderUserDashboard(); // Re-render user dashboard to reflect potential level changes
            }
            showModal(`Level ${level} added successfully!`);

            // Clear input fields
            newLevelNumberInput.value = '';
            newLevelInterestInput.value = '';
            newLevelMinBalanceInput.value = '';
            newLevelReferralsInput.value = '';
            newLevelWithdrawalLimitInput.value = '';
        }

        /**
         * Updates the website name.
         */
        function updateWebsiteName() {
            const newName = adminWebsiteNameInput.value.trim();
            if (!newName) {
                showModal('Website name cannot be empty.');
                return;
            }
            saveWebsiteName(newName);
            websiteTitleElem.textContent = newName;
            startScreenSettings.title = newName; // Also update start screen setting
            renderStartScreen(); // Re-render start screen
            showModal('Website name updated successfully!');
        }

        /**
         * Renders the theme settings panel in admin dashboard.
         */
        function renderThemeSettings() {
            // Populate the dropdown with theme names
            themeSelector.innerHTML = '';
            for (const themeName in THEMES) {
                const option = document.createElement('option');
                option.value = themeName;
                option.textContent = themeName;
                themeSelector.appendChild(option);
            }
            themeSelector.value = currentThemeName; // Set selected value to current theme

            // Populate other UI settings inputs
            fontSelector.value = uiSettings['font-family-primary'];
            baseFontSizeInput.value = parseFloat(uiSettings['font-size-base']);
            panelOpacityInput.value = parseFloat(uiSettings['panel-bg-opacity']);
            headingColorInput.value = uiSettings['text-color-heading'];
            primaryTextColorInput.value = uiSettings['text-color-primary'];
            panelBorderRadiusInput.value = parseFloat(uiSettings['panel-border-radius']);
            iconSizeInput.value = parseFloat(uiSettings['icon-size']);
            panelBaseBackgroundColorInput.value = uiSettings['panel-base-background-color']; // Populate color picker
        }

        /**
         * Renders the admin content management panel.
         */
        function renderAdminContentManagement() {
            adminContentList.innerHTML = ''; // Clear previous content

            if (adminManagedContent.length === 0) {
                adminContentList.innerHTML = '<p class="text-gray-500">No custom content added yet.</p>';
            } else {
                adminManagedContent.forEach(content => {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'p-3 rounded-md bg-gray-700 bg-opacity-50 border border-gray-600';
                    contentDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg text-white">${content.title} <span class="text-sm text-blue-300">(${content.type})</span></h4>
                            <div class="flex items-center space-x-2">
                                <label class="flex items-center text-gray-100 text-sm">
                                    <input type="checkbox" ${content.isActive ? 'checked' : ''} onchange="toggleContentActive('${content.id}', this.checked)" class="form-checkbox h-4 w-4 text-green-600 rounded">
                                    <span class="ml-1">Active</span>
                                </label>
                                <button onclick="editAdminContent('${content.id}')" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteAdminContent('${content.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <p class="text-base text-gray-100">${content.body}</p>
                        <p class="text-xs text-gray-400 mt-1">Target: ${content.global ? 'All Users' : (content.targetUserId || 'N/A')}</p>
                    `;
                    adminContentList.appendChild(contentDiv);
                });
            }
            // Clear the add new content form
            newContentTitleInput.value = '';
            newContentBodyInput.value = '';
            newContentTypeSelect.value = 'Announcement';
            newContentGlobalCheckbox.checked = true;
            newContentTargetUserInput.value = '';
            newContentTargetUserInput.disabled = true; // Disable by default if global is checked
        }

        /**
         * Adds new admin managed content.
         */
        function addAdminContent() {
            const title = newContentTitleInput.value.trim();
            const body = newContentBodyInput.value.trim();
            const type = newContentTypeSelect.value;
            const isGlobal = newContentGlobalCheckbox.checked;
            const targetUserId = isGlobal ? '' : newContentTargetUserInput.value.trim();

            if (!title || !body) {
                showModal('Please enter a title and content for the new item.');
                return;
            }
            if (!isGlobal && !targetUserId) {
                showModal('Please enter a Target User ID or make the content Global.');
                return;
            }

            const newContent = {
                id: generateUniqueId(),
                title: title,
                body: body,
                type: type,
                global: isGlobal,
                targetUserId: targetUserId,
                isActive: true
            };

            adminManagedContent.push(newContent);
            saveAdminContent(adminManagedContent);
            renderAdminContentManagement();
            if (currentUser) { // If a user is logged in, update their view
                renderUserAdminContent();
            }
            showModal('New content/task added successfully!');
        }

        /**
         * Edits existing admin managed content.
         * For simplicity, this will open a modal to edit.
         * In a more complex app, this might populate the "add new" form for editing.
         * @param {string} contentId The ID of the content to edit.
         */
        function editAdminContent(contentId) {
            const contentToEdit = adminManagedContent.find(c => c.id === contentId);
            if (!contentToEdit) {
                showModal('Content not found.');
                return;
            }

            // A more robust solution would be to use a dedicated edit modal or populate the add form
            // For now, let's use a prompt-based edit for simplicity.
            const newTitle = prompt('Edit Title:', contentToEdit.title);
            const newBody = prompt('Edit Content/Instructions:', contentToEdit.body);
            // Type, global, target user might be too complex for prompt, so skipping for now.
            // A dedicated modal with all fields would be better.

            if (newTitle !== null && newBody !== null) { // Check if user didn't cancel
                contentToEdit.title = newTitle.trim();
                contentToEdit.body = newBody.trim();
                saveAdminContent(adminManagedContent);
                renderAdminContentManagement();
                if (currentUser) {
                    renderUserAdminContent();
                }
                showModal('Content updated successfully!');
            }
        }

        /**
         * Deletes admin managed content.
         * @param {string} contentId The ID of the content to delete.
         */
        function deleteAdminContent(contentId) {
            if (confirm('Are you sure you want to delete this content item?')) {
                adminManagedContent = adminManagedContent.filter(content => content.id !== contentId);
                saveAdminContent(adminManagedContent);
                renderAdminContentManagement();
                if (currentUser) {
                    renderUserAdminContent();
                }
                showModal('Content deleted successfully!');
            }
        }

        /**
         * Toggles the active status of an admin managed content item.
         * @param {string} contentId The ID of the content to toggle.
         * @param {boolean} isActive The new active status.
         */
        function toggleContentActive(contentId, isActive) {
            const contentIndex = adminManagedContent.findIndex(c => c.id === contentId);
            if (contentIndex !== -1) {
                adminManagedContent[contentIndex].isActive = isActive;
                saveAdminContent(adminManagedContent);
                renderAdminContentManagement();
                if (currentUser) {
                    renderUserAdminContent();
                }
                showModal(`Content status updated to ${isActive ? 'Active' : 'Inactive'}.`);
            }
        }

        /**
         * Renders controls for managing user dashboard panel visibility.
         */
        function renderDashboardPanelVisibilityControls() {
            dashboardPanelVisibilityControls.innerHTML = ''; // Clear existing controls

            const panels = [
                { id: 'userOverviewPanel', name: 'User Overview' },
                { id: 'userLevelPanel', name: 'User Level' },
                { id: 'dailyInterestPanel', name: 'Daily Interest' },
                { id: 'rechargePanel', name: 'Recharge USDT' },
                { id: 'withdrawPanel', name: 'Withdraw USDT' },
                { id: 'userReferralPanel', name: 'User Referral Network' },
                { id: 'changeWithdrawalAddressPanel', name: 'Change Withdrawal Address' },
                { id: 'transactionHistoryPanel', name: 'Transaction History' },
                { id: 'levelDetailsPanel', name: 'Staking Level Details' },
                { id: 'userAdminContentPanel', name: 'Admin Announcements/Tasks' },
            ];

            panels.forEach(panel => {
                const isChecked = dashboardPanelVisibility[panel.id] !== false; // Default to true if not set
                const controlDiv = document.createElement('div');
                controlDiv.className = 'flex items-center justify-between p-2 bg-gray-700 bg-opacity-30 rounded-md';
                controlDiv.innerHTML = `
                    <label for="toggle-${panel.id}" class="text-gray-100">${panel.name}</label>
                    <input type="checkbox" id="toggle-${panel.id}" class="form-checkbox h-5 w-5 text-blue-600 rounded" ${isChecked ? 'checked' : ''}>
                `;
                dashboardPanelVisibilityControls.appendChild(controlDiv);

                document.getElementById(`toggle-${panel.id}`).addEventListener('change', (e) => {
                    dashboardPanelVisibility[panel.id] = e.target.checked;
                    saveDashboardPanelVisibility();
                    if (currentUser) {
                        renderUserDashboard(); // Re-render user dashboard to reflect changes
                    }
                    showModal(`${panel.name} visibility set to ${e.target.checked ? 'visible' : 'hidden'}.`);
                });
            });
        }


        /**
         * Approves a transaction (deposit or withdrawal).
         * @param {string} transactionId The ID of the transaction to approve.
         */
        function approveTransaction(transactionId) {
            let transactions = loadTransactions();
            let users = loadUsers();

            const txIndex = transactions.findIndex(tx => tx.id === transactionId);
            if (txIndex === -1) {
                showModal('Transaction not found.');
                return;
            }

            const transaction = transactions[txIndex];
            const userIndex = users.findIndex(u => u.id === transaction.userId);
            if (userIndex === -1) {
                showModal('User for this transaction not found.');
                return;
            }

            let user = users[userIndex];

            if (transaction.status !== 'pending') {
                showModal('This transaction has already been processed.');
                return;
            }

            transaction.status = 'approved';
            transactions[txIndex] = transaction; // Update status in admin queue

            // Find and update the transaction in the user's personal history
            const userTxIndex = user.transactions.findIndex(t => t.id === transaction.id);
            if (userTxIndex !== -1) {
                user.transactions[userTxIndex].status = 'approved';
            }


            if (transaction.type === 'deposit') {
                user.balance += transaction.amount;
                // Add to system funds when a user deposits
                systemFunds += transaction.amount;
                saveSystemFunds();

                // Set firstDepositTime if it's the first approved deposit for this user
                // Check if there are NO other approved deposits before setting firstDepositTime
                const hasApprovedDeposits = user.transactions.some(t => t.type === 'deposit' && t.status === 'approved');
                if (!hasApprovedDeposits) { // Only set if this is truly the first approved deposit
                    user.firstDepositTime = transaction.timestamp;
                }

                // Check if this is the first deposit of >= $100 for this user
                // We need to check if there was *any* approved deposit >= 100 before this one.
                const hasMadeFirstQualifyingDepositBefore = user.transactions.some(t =>
                    t.type === 'deposit' && t.status === 'approved' && t.amount >= 100 && t.id !== transaction.id
                );

                if (!hasMadeFirstQualifyingDepositBefore && transaction.amount >= 100 && user.referredBy) {
                    // This is the first qualifying deposit, award referral bonus
                    const referrer = users.find(u => u.userReferralCode === user.referredBy);
                    if (referrer) {
                        referrer.balance += REFERRAL_BONUS;
                        referrer.transactions.push({
                            id: generateUniqueId(),
                            userId: referrer.id,
                            type: 'referral_bonus',
                            amount: REFERRAL_BONUS,
                            status: 'credited',
                            timestamp: Date.now(),
                            referredUserId: user.id
                        });
                        if (!referrer.referredUsers.includes(user.id)) {
                            referrer.referredUsers.push(user.id);
                            referrer.directReferrals = referrer.referredUsers.length;
                        }
                        users[users.findIndex(u => u.id === referrer.id)] = referrer;
                        showModal(`Deposit approved. ${REFERRAL_BONUS} USDT credited to referrer ${referrer.email}.`);
                    } else if (user.referredBy === ADMIN_REFERRAL_CODE) {
                        // Admin referral, credit to system funds
                        systemFunds += REFERRAL_BONUS;
                        saveSystemFunds();
                        const adminTransactions = loadAdminTransactions();
                        adminTransactions.push({
                            id: generateUniqueId(),
                            type: 'admin_referral_bonus',
                            amount: REFERRAL_BONUS,
                            status: 'credited',
                            timestamp: Date.now(),
                            referredUserId: user.id,
                            note: `Admin referral bonus for user ${user.email}.`
                        });
                        saveAdminTransactions(adminTransactions);
                        showModal(`Deposit approved. ${REFERRAL_BONUS} USDT credited to system funds (admin referral).`);
                    }
                }
            } else if (transaction.type === 'withdrawal') {
                // For withdrawal, balance was already deducted on request.
                // Deduct from system funds when a user withdraws
                systemFunds -= transaction.amount;
                saveSystemFunds();

                // Set completion time
                const threeDaysFromNow = Date.now() + (3 * ONE_DAY_MS);
                user.withdrawalCompletionTime = threeDaysFromNow;

                // Update monthly withdrawal tracking
                const currentMonth = new Date().toLocaleString('en-US', { month: 'short', year: 'numeric' });
                user.lastWithdrawalMonth = currentMonth;
                user.lastWithdrawalAmount = (user.lastWithdrawalAmount || 0) + transaction.amount;
            }

            user.level = calculateUserLevel(user); // Recalculate level after balance/referral changes
            users[userIndex] = user;

            saveTransactions(transactions);
            saveUsers(users);
            showModal(`${transaction.type} request approved.`);
            renderAdminDashboard();
            if (currentUser && currentUser.id === user.id) { // If the approved user is the currently logged-in user
                renderUserDashboard(); // Re-render their dashboard to show updates
            }
        }

        /**
         * Declines a transaction (deposit or withdrawal).
         * @param {string} transactionId The ID of the transaction to decline.
         */
        function declineTransaction(transactionId) {
            let transactions = loadTransactions();
            let users = loadUsers();

            const txIndex = transactions.findIndex(tx => tx.id === transactionId);
            if (txIndex === -1) {
                showModal('Transaction not found.');
                return;
            }

            const transaction = transactions[txIndex];
            const userIndex = users.findIndex(u => u.id === transaction.userId);
            if (userIndex === -1) {
                showModal('User for this transaction not found.');
                return;
            }

            let user = users[userIndex];

            if (transaction.status !== 'pending') {
                showModal('This transaction has already been processed.');
                return;
            }

            transaction.status = 'declined';
            transactions[txIndex] = transaction; // Update status in admin queue

            // Find and update the transaction in the user's personal history
            const userTxIndex = user.transactions.findIndex(t => t.id === transaction.id);
            if (userTxIndex !== -1) {
                user.transactions[userTxIndex].status = 'declined';
            }

            if (transaction.type === 'withdrawal') {
                // Refund the balance if withdrawal is declined
                user.balance += transaction.amount;
            }

            users[userIndex] = user;

            saveTransactions(transactions);
            saveUsers(users);
            showModal(`${transaction.type} request declined.`);
            renderAdminDashboard();
            if (currentUser && currentUser.id === user.id) { // If the declined user is the currently logged-in user
                renderUserDashboard(); // Re-render their dashboard to show updates
            }
        }

        /**
         * Searches for a user by ID or email and populates the admin management panel.
         * @param {string} [userIdOrEmail] Optional: directly provide user ID to select.
         */
        function searchUserById(userIdOrEmail = adminUserIdSearch.value.trim()) {
            const users = loadUsers();
            selectedAdminUser = users.find(u => u.id === userIdOrEmail || u.email === userIdOrEmail);

            if (selectedAdminUser) {
                selectedUserWalletPanel.classList.remove('hidden');
                selectedUserEmailElem.textContent = selectedAdminUser.email;
                selectedUserIdElem.textContent = selectedAdminUser.id;
                selectedUserBalanceElem.textContent = selectedAdminUser.balance.toFixed(2);
                selectedUserPrimaryAddressElem.textContent = selectedAdminUser.primaryWithdrawalAddress || 'Not set';
                adminUpdateUserEmailInput.value = selectedAdminUser.email; // Populate email input
                adminUpdateWithdrawalAddressInput.value = selectedAdminUser.primaryWithdrawalAddress || '';
                adminAdjustBalanceAmountInput.value = '';

                // Populate level dropdown
                adminSetUserLevelSelect.innerHTML = '';
                const sortedLevels = Object.keys(LEVELS).map(Number).sort((a, b) => a - b);
                sortedLevels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = `Level ${level}`;
                    adminSetUserLevelSelect.appendChild(option);
                });
                adminSetUserLevelSelect.value = selectedAdminUser.level;

                showModal(`User ${selectedAdminUser.email} selected.`);
            } else {
                selectedUserWalletPanel.classList.add('hidden');
                showModal('User not found.');
            }
        }

        /**
         * Admin action to update a user's email address directly.
         */
        function adminUpdateUserEmail() {
            if (!selectedAdminUser) {
                showModal('Please select a user first.');
                return;
            }
            const newEmail = adminUpdateUserEmailInput.value.trim();
            if (!newEmail || !newEmail.includes('@') || !newEmail.includes('.')) {
                showModal('Please enter a valid email address.');
                return;
            }

            let users = loadUsers();
            if (users.some(u => u.email === newEmail && u.id !== selectedAdminUser.id)) {
                showModal('This email is already taken by another user.');
                return;
            }

            selectedAdminUser.email = newEmail;
            updateUserData(selectedAdminUser);
            searchUserById(selectedAdminUser.id); // Re-render selected user panel to show updated email
            showModal('User email updated successfully.');
        }

        /**
         * Admin action to set a user's primary withdrawal address directly.
         */
        function adminSetWithdrawalAddress() {
            if (!selectedAdminUser) {
                showModal('Please select a user first.');
                return;
            }
            const newAddress = adminUpdateWithdrawalAddressInput.value.trim();
            if (!newAddress) {
                showModal('Please enter a new BEP-20 address.');
                return;
            }
            if (!newAddress.startsWith('0x') || newAddress.length !== 42) {
                showModal('Please enter a valid BEP-20 address (starts with 0x and is 42 characters long).');
                return;
            }

            selectedAdminUser.primaryWithdrawalAddress = newAddress;
            selectedAdminUser.withdrawalAddresses = [newAddress]; // Keep array consistent with single address
            updateUserData(selectedAdminUser);
            searchUserById(selectedAdminUser.id); // Re-render selected user panel
            showModal('User\'s primary withdrawal address updated.');
        }

        /**
         * Admin action to adjust a user's balance directly.
         */
        function adminAdjustBalance() {
            if (!selectedAdminUser) {
                showModal('Please select a user first.');
                return;
            }
            const amount = parseFloat(adminAdjustBalanceAmountInput.value);
            if (isNaN(amount) || amount === 0) {
                showModal('Please enter a valid amount to adjust balance.');
                return;
            }

            selectedAdminUser.balance += amount;

            // Record this as an an admin adjustment transaction
            selectedAdminUser.transactions.push({
                id: generateUniqueId(),
                userId: selectedAdminUser.id,
                type: 'admin_adjusted',
                amount: amount,
                status: 'completed', // Admin adjustments are immediately completed
                timestamp: Date.now(),
                note: `Admin adjustment: ${amount > 0 ? 'Added' : 'Deducted'} ${Math.abs(amount).toFixed(2)} USDT`
            });

            updateUserData(selectedAdminUser);
            searchUserById(selectedAdminUser.id); // Re-render selected user panel
            adminAdjustBalanceAmountInput.value = '';
            showModal(`User balance adjusted by ${amount.toFixed(2)} USDT.`);
        }

        /**
         * Admin action to set a user's level directly.
         */
        function adminApplyUserLevel() {
            if (!selectedAdminUser) {
                showModal('Please select a user first.');
                return;
            }
            const newLevel = parseInt(adminSetUserLevelSelect.value);
            if (isNaN(newLevel) || !LEVELS[newLevel]) {
                showModal('Please select a valid level.');
                return;
            }

            selectedAdminUser.level = newLevel;
            updateUserData(selectedAdminUser);
            searchUserById(selectedAdminUser.id); // Re-render selected user panel
            showModal(`User ${selectedAdminUser.email}'s level updated to Level ${newLevel}.`);
        }

        /**
         * Admin action to deposit funds into the system's total funds.
         */
        function adminSystemDeposit() {
            const amount = parseFloat(adminSystemDepositAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showModal('Please enter a valid amount to deposit to system funds.');
                return;
            }

            systemFunds += amount;
            saveSystemFunds();

            const adminTransactions = loadAdminTransactions();
            adminTransactions.push({
                id: generateUniqueId(),
                type: 'admin_deposit',
                amount: amount,
                status: 'completed',
                timestamp: Date.now(),
                note: `Admin deposited ${amount.toFixed(2)} USDT to system funds.`
            });
            saveAdminTransactions(adminTransactions);

            adminSystemDepositAmountInput.value = '';
            renderAdminDashboard();
            showModal(`Successfully deposited ${amount.toFixed(2)} USDT to system funds.`);
        }

        /**
         * Admin action to withdraw funds from the system's total funds.
         */
        function adminSystemWithdraw() {
            const amount = parseFloat(adminSystemWithdrawAmountInput.value);
            const withdrawAddress = adminSystemWithdrawAddressInput.value.trim();

            if (isNaN(amount) || amount <= 0) {
                showModal('Please enter a valid amount to withdraw from system funds.');
                return;
            }
            if (!withdrawAddress || !withdrawAddress.startsWith('0x') || withdrawAddress.length !== 42) {
                showModal('Please enter a valid BEP-20 address for withdrawal.');
                return;
            }
            if (amount > systemFunds) {
                showModal('Insufficient system funds for this withdrawal.');
                return;
            }

            systemFunds -= amount;
            saveSystemFunds();

            const adminTransactions = loadAdminTransactions();
            adminTransactions.push({
                id: generateUniqueId(),
                type: 'admin_withdrawal',
                amount: amount,
                walletAddress: withdrawAddress,
                status: 'completed',
                timestamp: Date.now(),
                note: `Admin withdrew ${amount.toFixed(2)} USDT from system funds to ${withdrawAddress}.`
            });
            saveAdminTransactions(adminTransactions);

            adminSystemWithdrawAmountInput.value = '';
            adminSystemWithdrawAddressInput.value = '';
            renderAdminDashboard();
            showModal(`Successfully withdrew ${amount.toFixed(2)} USDT from system funds.`);
        }

        /**
         * Admin action to update the global deposit address.
         */
        function adminSetGlobalDepositAddress() {
            const newAddress = newGlobalDepositAddressInput.value.trim();
            if (!newAddress) {
                showModal('Please enter a new global BEP-20 deposit address.');
                return;
            }
            if (!newAddress.startsWith('0x') || newAddress.length !== 42) {
                showModal('Please enter a valid BEP-20 address (starts with 0x and is 42 characters long).');
                return;
            }

            saveGlobalDepositAddress(newAddress); // Save to local storage and update RECHARGE_ADDRESS
            renderAdminDashboard(); // Re-render admin dashboard to show updated address
            if (currentUser) {
                renderUserDashboard(); // Re-render user dashboard to show updated address
            }
            newGlobalDepositAddressInput.value = ''; // Clear input field
            showModal('Global deposit address updated successfully!');
        }

        /**
         * Admin action to update the withdrawal restriction days.
         */
        function updateWithdrawalRestriction() {
            const newDays = parseInt(newWithdrawalRestrictionDaysInput.value);
            if (isNaN(newDays) || newDays < 0) {
                showModal('Please enter a valid non-negative number of days for the restriction.');
                return;
            }
            saveWithdrawalRestrictionDays(newDays);
            renderAdminDashboard(); // Re-render admin dashboard to show updated value
            showModal(`Withdrawal restriction updated to ${newDays} days.`);
        }

        /**
         * Admin action to remove the withdrawal restriction (sets to 0 days).
         */
        function removeWithdrawalRestriction() {
            saveWithdrawalRestrictionDays(0);
            renderAdminDashboard(); // Re-render admin dashboard to show updated value
            showModal('Withdrawal restriction removed (set to 0 days).');
        }


        /**
         * Renders the list of users referred by the admin.
         */
        function renderAdminReferredUsers() {
            adminReferredUsersListElem.innerHTML = '';
            const allUsers = loadUsers();
            const adminReferredUsers = allUsers.filter(user => user.referredBy === ADMIN_REFERRAL_CODE);

            if (adminReferredUsers.length === 0) {
                adminReferredUsersListElem.innerHTML = '<p class="text-gray-500">No users referred by admin yet.</p>';
                return;
            }

            adminReferredUsers.forEach(user => {
                const totalDeposits = user.transactions.filter(tx => tx.type === 'deposit' && tx.status === 'approved').reduce((sum, tx) => sum + tx.amount, 0);
                const totalWithdrawals = user.transactions.filter(tx => tx.type === 'withdrawal' && tx.status === 'approved').reduce((sum, tx) => sum + tx.amount, 0);

                const userDiv = document.createElement('div');
                userDiv.className = 'card bg-gray-800 bg-opacity-40 p-4 rounded-md space-y-2';
                userDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-lg text-white">${user.email}</p>
                        <button onclick="searchUserById('${user.id}')" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600">Manage</button>
                    </div>
                    <p class="text-sm text-gray-100">ID: <span class="font-mono text-xs break-all text-blue-200">${user.id}</span></p>
                    <p class="text-sm text-gray-100">Withdrawal Address: <span class="font-mono text-xs break-all text-green-300">${user.primaryWithdrawalAddress || 'Not set'}</span></p>
                    <p class="text-sm text-gray-100">Deposits: <span class="text-green-400">${totalDeposits.toFixed(2)} USDT</span> | Withdrawals: <span class="text-red-400">${totalWithdrawals.toFixed(2)} USDT</span></p>
                    <p class="text-sm text-gray-100">Current Balance: <span class="text-yellow-400">${user.balance.toFixed(2)} USDT</span></p>
                    <p class="text-sm text-gray-100">Direct Referrals: <span class="text-blue-400">${user.directReferrals}</span> | Level: <span class="text-purple-400">${user.level}</span></p>
                `;
                adminReferredUsersListElem.appendChild(userDiv);
            });
        }

        /**
         * Renders the restriction message management panel in admin dashboard.
         */
        function renderAdminRestrictionMessages() {
            adminRestrictionMessagesListElem.innerHTML = ''; // Clear previous content

            if (adminRestrictionMessages.length === 0) {
                adminRestrictionMessagesListElem.innerHTML = '<p class="text-gray-500">No custom restriction messages added yet.</p>';
                return;
            }

            adminRestrictionMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'p-3 rounded-md bg-gray-700 bg-opacity-50 border border-gray-600';
                msgDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-lg text-white">
                            ${msg.type === 'deposit' ? '<i class="fas fa-arrow-down text-green-400 mr-2"></i> Deposit' : '<i class="fas fa-arrow-up text-red-400 mr-2"></i> Withdrawal'}
                            Restriction
                        </h4>
                        <div class="flex items-center space-x-2">
                            <label class="flex items-center text-gray-100 text-sm">
                                <input type="checkbox" ${msg.isActive ? 'checked' : ''} onchange="toggleRestrictionMessageActive('${msg.id}', this.checked)" class="form-checkbox h-4 w-4 text-green-600 rounded">
                                <span class="ml-1">Active</span>
                            </label>
                            <button onclick="editRestrictionMessage('${msg.id}')" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteRestrictionMessage('${msg.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <p class="text-base text-gray-100">${msg.message}</p>
                    <p class="text-xs text-gray-400 mt-1">Added: ${new Date(msg.timestamp).toLocaleString()}</p>
                `;
                adminRestrictionMessagesListElem.appendChild(msgDiv);
            });
            // Clear the add new message form
            newRestrictionMessageTypeSelect.value = 'deposit';
            newRestrictionMessageContentInput.value = '';
            newRestrictionMessageActiveCheckbox.checked = true;
        }

        /**
         * Adds a new restriction message.
         */
        function addRestrictionMessage() {
            const type = newRestrictionMessageTypeSelect.value;
            const message = newRestrictionMessageContentInput.value.trim();
            const isActive = newRestrictionMessageActiveCheckbox.checked;

            if (!message) {
                showModal('Please enter a message for the restriction.');
                return;
            }

            const newMsg = {
                id: generateUniqueId(),
                type: type,
                message: message,
                isActive: isActive,
                timestamp: Date.now()
            };

            adminRestrictionMessages.push(newMsg);
            saveRestrictionMessages(adminRestrictionMessages);
            renderAdminRestrictionMessages();
            if (currentUser) {
                renderUserRestrictionMessages(); // Update user view if logged in
            }
            showModal('Restriction message added successfully!');
        }

        /**
         * Edits an existing restriction message.
         * @param {string} msgId The ID of the message to edit.
         */
        function editRestrictionMessage(msgId) {
            const msgToEdit = adminRestrictionMessages.find(msg => msg.id === msgId);
            if (!msgToEdit) {
                showModal('Message not found.');
                return;
            }

            const newContent = prompt('Edit Message Content:', msgToEdit.message);

            if (newContent !== null) { // Check if user didn't cancel
                msgToEdit.message = newContent.trim();
                saveRestrictionMessages(adminRestrictionMessages);
                renderAdminRestrictionMessages();
                if (currentUser) {
                    renderUserRestrictionMessages();
                }
                showModal('Restriction message updated successfully!');
            }
        }

        /**
         * Deletes a restriction message.
         * @param {string} msgId The ID of the message to delete.
         */
        function deleteRestrictionMessage(msgId) {
            if (confirm('Are you sure you want to delete this restriction message?')) {
                adminRestrictionMessages = adminRestrictionMessages.filter(msg => msg.id !== msgId);
                saveRestrictionMessages(adminRestrictionMessages);
                renderAdminRestrictionMessages();
                if (currentUser) {
                    renderUserRestrictionMessages();
                }
                showModal('Restriction message deleted successfully!');
            }
        }

        /**
         * Toggles the active status of a restriction message.
         * @param {string} msgId The ID of the message to toggle.
         * @param {boolean} isActive The new active status.
         */
        function toggleRestrictionMessageActive(msgId, isActive) {
            const msgIndex = adminRestrictionMessages.findIndex(msg => msg.id === msgId);
            if (msgIndex !== -1) {
                adminRestrictionMessages[msgIndex].isActive = isActive;
                saveRestrictionMessages(adminRestrictionMessages);
                renderAdminRestrictionMessages();
                if (currentUser) {
                    renderUserRestrictionMessages();
                }
                showModal(`Restriction message status updated to ${isActive ? 'Active' : 'Inactive'}.`);
            }
        }

        /**
         * Renders the admin start screen customization panel.
         */
        function renderAdminStartScreenCustomization() {
            startScreenTitleInput.value = startScreenSettings.title;
            startScreenSubtitleInput.value = startScreenSettings.subtitle;
            startScreenTitleFontSizeInput.value = parseFloat(startScreenSettings.titleFontSize);
            startScreenSubtitleFontSizeInput.value = parseFloat(startScreenSettings.subtitleFontSize);
            startScreenPanelPaddingInput.value = parseFloat(startScreenSettings.panelPadding);
            showGetStartedButtonCheckbox.checked = startScreenSettings.showGetStartedButton;

            // Populate theme selector for start screen
            startScreenThemeSelector.innerHTML = '';
            for (const themeName in THEMES) {
                const option = document.createElement('option');
                option.value = themeName;
                option.textContent = themeName;
                startScreenThemeSelector.appendChild(option);
            }
            startScreenThemeSelector.value = currentThemeName; // Set selected value to current theme

            // Render custom content list for start screen
            startScreenCustomContentListElem.innerHTML = '';
            if (startScreenSettings.customContent.length === 0) {
                startScreenCustomContentListElem.innerHTML = '<p class="text-gray-500">No custom content for start screen yet.</p>';
            } else {
                startScreenSettings.customContent.forEach(content => {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'p-3 rounded-md bg-gray-700 bg-opacity-50 border border-gray-600';
                    contentDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg text-white">${content.title || 'Untitled Content'}</h4>
                            <div class="flex items-center space-x-2">
                                <label class="flex items-center text-gray-100 text-sm">
                                    <input type="checkbox" ${content.isActive ? 'checked' : ''} onchange="toggleStartScreenContentActive('${content.id}', this.checked)" class="form-checkbox h-4 w-4 text-green-600 rounded">
                                    <span class="ml-1">Active</span>
                                </label>
                                <button onclick="editStartScreenContent('${content.id}')" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteStartScreenContent('${content.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <p class="text-base text-gray-100">${content.body}</p>
                    `;
                    startScreenCustomContentListElem.appendChild(contentDiv);
                });
            }
            // Clear add new custom content form
            newStartScreenContentTitleInput.value = '';
            newStartScreenContentBodyInput.value = '';
            newStartScreenContentActiveCheckbox.checked = true;
        }

        /**
         * Applies start screen settings.
         */
        function applyStartScreenSettings() {
            startScreenSettings.title = startScreenTitleInput.value.trim();
            startScreenSettings.subtitle = startScreenSubtitleInput.value.trim();
            startScreenSettings.titleFontSize = `${startScreenTitleFontSizeInput.value}rem`;
            startScreenSettings.subtitleFontSize = `${startScreenSubtitleFontSizeInput.value}rem`;
            startScreenSettings.panelPadding = `${startScreenPanelPaddingInput.value}rem`;
            startScreenSettings.showGetStartedButton = showGetStartedButtonCheckbox.checked;

            saveStartScreenSettings();
            renderStartScreen(); // Re-render the actual start screen
            showModal('Start screen settings applied successfully!');
        }

        /**
         * Renders the start screen based on current settings.
         */
        function renderStartScreen() {
            startScreenTitleElem.textContent = startScreenSettings.title;
            startScreenSubtitleElem.textContent = startScreenSettings.subtitle;
            startScreenTitleElem.style.fontSize = startScreenSettings.titleFontSize;
            startScreenSubtitleElem.style.fontSize = startScreenSettings.subtitleFontSize;
            startScreenPanelElem.style.padding = startScreenSettings.panelPadding;
            getStartedBtn.classList.toggle('hidden', !startScreenSettings.showGetStartedButton);

            // Render custom content
            startScreenCustomContentElem.innerHTML = '';
            const activeCustomContent = startScreenSettings.customContent.filter(c => c.isActive);
            activeCustomContent.forEach(content => {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'bg-gray-800/50 p-3 rounded-lg shadow-md';
                if (content.title) {
                    contentDiv.innerHTML += `<h4 class="font-semibold text-lg text-blue-300 mb-1">${content.title}</h4>`;
                }
                contentDiv.innerHTML += `<p class="text-gray-200 text-base">${content.body}</p>`;
                startScreenCustomContentElem.appendChild(contentDiv);
            });
        }

        /**
         * Adds new custom content for the start screen.
         */
        function addStartScreenContent() {
            const title = newStartScreenContentTitleInput.value.trim();
            const body = newStartScreenContentBodyInput.value.trim();
            const isActive = newStartScreenContentActiveCheckbox.checked;

            if (!body) {
                showModal('Please enter content text for the new item.');
                return;
            }

            const newContent = {
                id: generateUniqueId(),
                title: title,
                body: body,
                isActive: isActive
            };

            startScreenSettings.customContent.push(newContent);
            saveStartScreenSettings();
            renderAdminStartScreenCustomization(); // Re-render admin panel
            renderStartScreen(); // Re-render start screen
            showModal('Custom start screen content added successfully!');
        }

        /**
         * Edits custom content for the start screen.
         * @param {string} contentId The ID of the content to edit.
         */
        function editStartScreenContent(contentId) {
            const contentToEdit = startScreenSettings.customContent.find(c => c.id === contentId);
            if (!contentToEdit) {
                showModal('Content not found.');
                return;
            }

            const newTitle = prompt('Edit Content Title (Optional):', contentToEdit.title || '');
            const newBody = prompt('Edit Content Text:', contentToEdit.body);

            if (newTitle !== null && newBody !== null) {
                contentToEdit.title = newTitle.trim();
                contentToEdit.body = newBody.trim();
                saveStartScreenSettings();
                renderAdminStartScreenCustomization();
                renderStartScreen();
                showModal('Custom start screen content updated successfully!');
            }
        }

        /**
         * Deletes custom content from the start screen.
         * @param {string} contentId The ID of the content to delete.
         */
        function deleteStartScreenContent(contentId) {
            if (confirm('Are you sure you want to delete this custom start screen content?')) {
                startScreenSettings.customContent = startScreenSettings.customContent.filter(content => content.id !== contentId);
                saveStartScreenSettings();
                renderAdminStartScreenCustomization();
                renderStartScreen();
                showModal('Custom start screen content deleted successfully!');
            }
        }

        /**
         * Toggles the active status of custom start screen content.
         * @param {string} contentId The ID of the content to toggle.
         * @param {boolean} isActive The new active status.
         */
        function toggleStartScreenContentActive(contentId, isActive) {
            const contentIndex = startScreenSettings.customContent.findIndex(c => c.id === contentId);
            if (contentIndex !== -1) {
                startScreenSettings.customContent[contentIndex].isActive = isActive;
                saveStartScreenSettings();
                renderAdminStartScreenCustomization();
                renderStartScreen();
                showModal(`Start screen content status updated to ${isActive ? 'Active' : 'Inactive'}.`);
            }
        }


        // --- Three.js Functions (Abstract Crystal Structures Theme) ---

        /**
         * Initializes the Three.js scene for the animated background with Abstract Crystal Structures.
         */
        function initThreeJs() {
            const canvas = document.getElementById('threeJsCanvas');
            if (!canvas) return;

            window.objects = []; // Explicitly re-initialize the array

            window.scene = new THREE.Scene();
            window.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            window.renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });

            window.renderer.setSize(window.innerWidth, window.innerHeight);
            window.renderer.setPixelRatio(window.devicePixelRatio);

            // Lighting for crystal structures
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8); // Soft ambient light
            window.scene.add(ambientLight);

            // Directional light to highlight facets
            const directionalLight1 = new THREE.DirectionalLight(0x88EEFF, 1.5); // Cyan light
            directionalLight1.position.set(100, 100, 100);
            window.scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xFF88CC, 1.2); // Pink light
            directionalLight2.position.set(-100, -50, -100);
            window.scene.add(directionalLight2);

            const directionalLight3 = new THREE.DirectionalLight(0xFFFF88, 1.0); // Yellow light
            directionalLight3.position.set(0, 150, 50);
            window.scene.add(directionalLight3);

            // Materials for crystal objects - highly reflective and transparent
            const crystalMaterialSettings = {
                metalness: 0.9,
                roughness: 0.1,
                transparent: true,
                opacity: 0.3, // More transparent
                depthWrite: false,
                clearcoat: 1.0,
                clearcoatRoughness: 0.1
            };

            const crystalMaterials = [
                new THREE.MeshStandardMaterial({ color: 0x8A2BE2, emissive: 0x4B0082, ...crystalMaterialSettings }), // BlueViolet
                new THREE.MeshStandardMaterial({ color: 0x00CED1, emissive: 0x008B8B, ...crystalMaterialSettings }), // DarkTurquoise
                new THREE.MeshStandardMaterial({ color: 0xFFD700, emissive: 0xB8860B, ...crystalMaterialSettings }), // Gold
                new THREE.MeshStandardMaterial({ color: 0x32CD32, emissive: 0x228B22, ...crystalMaterialSettings }), // LimeGreen
                new THREE.MeshStandardMaterial({ color: 0xFF69B4, emissive: 0xC71585, ...crystalMaterialSettings }), // HotPink
                new THREE.MeshStandardMaterial({ color: 0x1E90FF, emissive: 0x0000CD, ...crystalMaterialSettings }), // DodgerBlue
            ];

            // Geometric shapes for crystals
            const crystalGeometries = [
                new THREE.BoxGeometry(1.2, 1.2, 1.2), // Slightly larger boxes
                new THREE.DodecahedronGeometry(1.0),
                new THREE.OctahedronGeometry(1.1),
                new THREE.IcosahedronGeometry(1.2),
                new THREE.ConeGeometry(0.8, 1.8, 32),
                new THREE.CylinderGeometry(0.6, 0.6, 1.8, 32),
                new THREE.TorusKnotGeometry(0.7, 0.2, 64, 8) // Complex knot
            ];

            for (let i = 0; i < 150; i++) { // Fewer objects, but more prominent
                const geometry = crystalGeometries[Math.floor(Math.random() * crystalGeometries.length)];
                const material = crystalMaterials[Math.floor(Math.random() * crystalMaterials.length)];
                const mesh = new THREE.Mesh(geometry, material);

                mesh.position.x = Math.random() * 200 - 100;
                mesh.position.y = Math.random() * 200 - 100;
                mesh.position.z = Math.random() * 200 - 100;

                mesh.rotation.x = Math.random() * Math.PI;
                mesh.rotation.y = Math.random() * Math.PI;
                mesh.rotation.z = Math.random() * Math.PI;

                const scale = Math.random() * 0.6 + 0.4; // Scale from 0.4 to 1.0
                mesh.scale.set(scale, scale, scale);

                window.scene.add(mesh);
                window.objects.push(mesh);
            }

            window.camera.position.z = 5;

            document.addEventListener('mousemove', onDocumentMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
        }

        /**
         * Animation loop for Three.js with Abstract Crystal Structures.
         */
        function animateThreeJs() {
            requestAnimationFrame(animateThreeJs);

            // Animate objects - slower, more elegant rotations and subtle shifts
            window.objects.forEach(obj => {
                obj.rotation.x += 0.001 + (Math.sin(Date.now() * 0.0001 + obj.uuid.charCodeAt(0)) * 0.0005);
                obj.rotation.y += 0.001 + (Math.cos(Date.now() * 0.0001 + obj.uuid.charCodeAt(1)) * 0.0005);
                // Subtle vertical oscillation
                obj.position.y += Math.sin(Date.now() * 0.0003 + obj.uuid.charCodeAt(2)) * 0.005;
            });

            // Camera movement based on mouse - responsive
            window.camera.position.x += (window.mouseX / 800 - window.camera.position.x) * 0.05;
            window.camera.position.y += (-window.mouseY / 800 - window.camera.position.y) * 0.05;
            window.camera.lookAt(window.scene.position);

            window.renderer.render(window.scene, window.camera);
        }

        /**
         * Handles window resizing for Three.js canvas.
         */
        function onWindowResize() {
            window.windowHalfX = window.innerWidth / 2;
            window.windowHalfY = window.innerHeight / 2;

            window.camera.aspect = window.innerWidth / window.innerHeight;
            window.camera.updateProjectionMatrix();
            window.renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * Handles mouse movement for camera control.
         * @param {MouseEvent} event The mouse event.
         */
        function onDocumentMouseMove(event) {
            window.mouseX = (event.clientX - window.windowHalfX);
            window.mouseY = (event.clientY - window.windowHalfY);
        }


        // --- Event Listeners ---
        window.onload = function() {
            initThreeJs(); // Initialize 3D background
            animateThreeJs(); // Start 3D animation loop

            loadLevelsConfig(); // Load level configurations first
            systemFunds = loadSystemFunds(); // Load system funds on startup
            RECHARGE_ADDRESS = loadGlobalDepositAddress(); // Load global deposit address on startup
            currentWebsiteName = loadWebsiteName(); // Load website name
            currentThemeName = loadThemeName(); // Load theme name
            adminManagedContent = loadAdminContent(); // Load admin managed content
            loadUISettings(); // Load general UI settings
            loadDashboardPanelVisibility(); // Load dashboard panel visibility
            WITHDRAWAL_LOCK_PERIOD_DAYS = loadWithdrawalRestrictionDays(); // Load withdrawal restriction days
            adminRestrictionMessages = loadRestrictionMessages(); // Load restriction messages
            loadStartScreenSettings(); // Load start screen settings

            // Apply loaded settings
            websiteTitleElem.textContent = currentWebsiteName;
            renderStartScreen(); // Render start screen with loaded settings
            applyUISettings(true); // Apply all UI settings (theme, font, colors, etc.) but suppress modal on initial load
            isInitialLoad = false; // Set flag to false after initial load

            showSection(startScreen);
            updateHeaderButtons();
            rechargeAddressElem.textContent = RECHARGE_ADDRESS; // Set the recharge address

            // Initialize theme selector
            if (themeSelector) themeSelector.value = currentThemeName;
            if (startScreenThemeSelector) startScreenThemeSelector.value = currentThemeName; // Initialize start screen theme selector
        };

        getStartedBtn.addEventListener('click', () => showSection(signUpFormSection));
        showSignUpBtn.addEventListener('click', () => showSection(signUpFormSection));
        showSignInBtn.addEventListener('click', () => showSection(signInFormSection));
        signOutBtn.addEventListener('click', handleSignOut);

        linkToSignIn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(signInFormSection);
        });
        linkToSignUp.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(signUpFormSection);
        });

        signUpForm.addEventListener('submit', handleSignUp);
        signInForm.addEventListener('submit', handleSignIn);

        submitRechargeBtn.addEventListener('click', handleSubmitRecharge);
        submitWithdrawBtn.addEventListener('click', handleSubmitWithdrawal);
        setPrimaryWithdrawalAddressBtn.addEventListener('click', setPrimaryWithdrawalAddress);

        // Admin Panel Event Listeners
        searchUserBtn.addEventListener('click', () => searchUserById());
        adminUpdateUserEmailBtn.addEventListener('click', adminUpdateUserEmail);
        adminSetWithdrawalAddressBtn.addEventListener('click', adminSetWithdrawalAddress);
        adminAdjustBalanceBtn.addEventListener('click', adminAdjustBalance);
        adminApplyUserLevelBtn.addEventListener('click', adminApplyUserLevel); // New listener for setting user level
        adminSystemDepositBtn.addEventListener('click', adminSystemDeposit);
        adminSystemWithdrawBtn.addEventListener('click', adminSystemWithdraw);
        setGlobalDepositAddressBtn.addEventListener('click', adminSetGlobalDepositAddress);
        addNewLevelBtn.addEventListener('click', addLevelConfig); // Event listener for adding new level
        updateWebsiteNameBtn.addEventListener('click', updateWebsiteName); // Event listener for website name update
        // Check if applyUISettingsBtn exists before adding listener
        if (applyUISettingsBtn) {
            applyUISettingsBtn.addEventListener('click', applyUISettings); // Event listener for applying all UI settings
        }


        // Admin Content Management Listeners
        addNewContentBtn.addEventListener('click', addAdminContent);
        newContentGlobalCheckbox.addEventListener('change', (e) => {
            newContentTargetUserInput.disabled = e.target.checked;
            if (e.target.checked) {
                newContentTargetUserInput.value = ''; // Clear if global
            }
        });

        // New Admin Withdrawal Restriction Listeners
        updateWithdrawalRestrictionBtn.addEventListener('click', updateWithdrawalRestriction);
        removeWithdrawalRestrictionBtn.addEventListener('click', removeWithdrawalRestriction);

        // New Admin Restriction Message Listeners
        addNewRestrictionMessageBtn.addEventListener('click', addRestrictionMessage);

        // New Admin Start Screen Customization Listeners
        if (applyStartScreenSettingsBtn) { // Check if element exists
            applyStartScreenSettingsBtn.addEventListener('click', applyStartScreenSettings);
        }
        if (addStartScreenContentBtn) { // Check if element exists
            addStartScreenContentBtn.addEventListener('click', addStartScreenContent);
        }
        if (startScreenThemeSelector) { // Check if element exists
            startScreenThemeSelector.addEventListener('change', (e) => {
                currentThemeName = e.target.value;
                if (themeSelector) themeSelector.value = currentThemeName; // Keep main theme selector in sync
                applyUISettings(true); // Apply theme without showing modal
            });
        }
    </script>
</body>
</html>
